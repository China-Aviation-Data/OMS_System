<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单管理系统</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- SheetJS 用于导出 XLSX -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#64748b',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        info: '#3b82f6',
                        light: '#f8fafc',
                        dark: '#1e293b'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-all {
                transition-property: all;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 150ms;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }
    </style>
    <style>
        /* 自定义动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-in-out forwards;
        }
        
        .animate-delay-100 { animation-delay: 0.1s; }
        .animate-delay-200 { animation-delay: 0.2s; }
        .animate-delay-300 { animation-delay: 0.3s; }
        
        /* 状态颜色 */
        .status-pending { background-color: #f59e0b; color: white; }
        body.dark { background-color: #1f2937; color: #e5e7eb; }
        body.dark .bg-white { background-color: #111827 !important; }
        body.dark .text-gray-800 { color: #e5e7eb !important; }
        body.dark .border-gray-200 { border-color: #334155 !important; }
        body.dark .bg-gray-50 { background-color: #1f2937 !important; }
        body.dark .text-gray-700 { color: #cbd5e1 !important; }
        body.dark .bg-primary { background-color: #0b2563 !important; }
        body.dark #settings-modal select, body.dark #settings-modal option { color: #000 !important; }
        body.dark #settings-dropdown a { color: #fff !important; }
        body.dark #settings-dropdown a:hover { background-color: #6b7280 !important; }
        .status-completed { background-color: #10b981; color: white; }
        .status-cancelled { background-color: #ef4444; color: white; }
        .status-soldOut { background-color: #64748b; color: white; }
        
        /* 响应式调整 */
        @media (min-width: 768px) {
            .desktop-layout {
                display: grid;
                grid-template-columns: minmax(280px, 20rem) 1fr;
                gap: 1.5rem;
                align-items: start;
            }
            .sidebar-sticky {
                position: sticky;
                top: 1rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- 登录页面 -->
    <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md animate-fadeIn">
            <div class="text-center mb-8">
                <h1 id="login-page-title" class="text-3xl font-bold text-primary">订单管理系统</h1>
                <p id="login-subtitle" class="text-gray-500 mt-2">请登录以访问系统</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label id="label-username" for="username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                            <i class="fa fa-user"></i>
                        </span>
                        <input type="text" id="username" name="username" required
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                </div>
                
                <div>
                    <label id="label-password" for="password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                            <i class="fa fa-lock"></i>
                        </span>
                        <input type="password" id="password" name="password" required
                               class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <button type="button" id="press-to-show-password" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-gray-700">
                            <i class="fa fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="remember-me" class="h-4 w-4 text-primary border-gray-300 rounded">
                    <label for="remember-me" class="text-sm text-gray-700">记住我（本设备一小时免密）</label>
                </div>
                
                <div id="error-message" class="hidden text-red-500 text-sm text-center"></div>
                
                <button type="submit" class="w-full bg-primary hover:bg-blue-800 text-white font-medium py-2.5 px-4 rounded-md transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary" id="login-submit-btn">登录</button>
            </form>
        </div>
    </div>

    <!-- 主界面 -->
    <div id="main-app" class="hidden min-h-screen bg-gray-100">
        <!-- 顶部导航栏 -->
        <header class="bg-primary text-white shadow-md sticky top-0 z-30">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fa fa-shopping-bag text-xl"></i>
                    <h1 id="app-title" class="text-xl font-bold">订单管理系统</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="hidden md:flex items-center space-x-2">
                        <span id="welcome-label" class="text-sm">欢迎，</span>
                        <span id="current-user" class="font-medium"></span>
                    </div>
                    
                    <!-- 设置下拉菜单 -->
                    <div class="relative" id="settings-dropdown-container">
                        <button id="settings-dropdown-btn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-3 py-1.5 rounded-md text-sm transition-all flex items-center">
                            <i class="fa fa-cog mr-1"></i> <span id="settings-button-text">设置</span>
                            <i class="fa fa-chevron-down ml-1 text-xs"></i>
                        </button>
                        
                        <div id="settings-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10 hidden">
                            <a href="#" id="order-management-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fa fa-file-text-o mr-2"></i> 订单管理
                            </a>
                            <a href="#" id="customer-management-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fa fa-users mr-2"></i> 客户管理
                            </a>
                            <a href="#" id="product-management-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fa fa-cubes mr-2"></i> 商品管理
                            </a>
                            <a href="#" id="financial-management-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fa fa-line-chart mr-2"></i> 财务管理
                            </a>
                            <a href="#" id="operator-logs-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fa fa-user-circle mr-2"></i> 操作者与日志
                            </a>
                            <a href="#" id="export-orders-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fa fa-download mr-2"></i> 导出订单 XLSX
                            </a>
                            <a href="#" id="export-customers-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fa fa-download mr-2"></i> 导出客户 XLSX
                            </a>
                            <a href="#" id="export-combined-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fa fa-download mr-2"></i> 导出数据（订单+客户）
                            </a>
                            <a href="#" id="import-combined-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fa fa-upload mr-2"></i> 导入数据（xls/xlsx）
                            </a>
                            <div class="border-t border-gray-100 my-1"></div>
                            <a href="#" id="logout-link" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
                                <i class="fa fa-sign-out mr-2"></i> 退出登录
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- 主内容区 -->
        <main class="container mx-auto px-4 py-6">
            <div class="desktop-layout">
                <!-- 左侧操作区 -->
                <div class="sidebar-sticky bg-white rounded-lg shadow-md p-4 mb-6 md:mb-0 animate-fadeIn animate-delay-100">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-semibold text-gray-800">操作菜单</h2>
                        <span id="mobile-username" class="text-sm font-medium text-gray-600 md:hidden"></span>
                    </div>
                    
                    <div class="space-y-4">
                        <button id="new-order-btn" class="w-full bg-success hover:bg-green-700 text-white font-medium py-2.5 px-4 rounded-md transition-all flex items-center justify-center">
                            <i class="fa fa-plus-circle mr-2"></i> 新增订单
                        </button>
                        
                        <button id="new-product-btn" class="w-full bg-info hover:bg-blue-700 text-white font-medium py-2.5 px-4 rounded-md transition-all flex items-center justify-center">
                            <i class="fa fa-cubes mr-2"></i> 新增商品
                        </button>
                        

                        
                        <div class="pt-4 border-t border-gray-200">
                            <h3 class="text-sm font-medium text-gray-500 mb-3">订单筛选</h3>
                            
                            <div class="space-y-2">
                                <button class="filter-btn w-full text-left px-3 py-2 rounded-md bg-primary text-white" data-filter="all">
                                    <i class="fa fa-list-ul mr-2"></i> 全部订单
                                </button>
                                <button class="filter-btn w-full text-left px-3 py-2 rounded-md hover:bg-gray-100" data-filter="pending">
                                    <i class="fa fa-clock-o mr-2"></i> 待处理
                                </button>
                                <button class="filter-btn w-full text-left px-3 py-2 rounded-md hover:bg-gray-100" data-filter="completed">
                                    <i class="fa fa-check-circle mr-2"></i> 已完成
                                </button>
                                <button class="filter-btn w-full text-left px-3 py-2 rounded-md hover:bg-gray-100" data-filter="cancelled">
                                    <i class="fa fa-times-circle mr-2"></i> 已取消
                                </button>
                                <button class="filter-btn w-full text-left px-3 py-2 rounded-md hover:bg-gray-100" data-filter="soldOut">
                                    <i class="fa fa-ban mr-2"></i> 已售罄
                                </button>
                                <button class="filter-btn w-full text-left px-3 py-2 rounded-md hover:bg-gray-100" data-filter="history">
                                    <i class="fa fa-history mr-2"></i> 历史订单
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 右侧订单区 -->
                <div class="animate-fadeIn animate-delay-200">
                    <!-- 订单列表标题 -->
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-800">
                            <span id="order-count">0</span> 个订单
                        </h2>
                        
                        <div class="relative">
                            <input type="text" id="search-orders" placeholder="搜索订单..."
                                   class="pl-9 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-search"></i>
                            </span>
                        </div>
                    </div>
                    
                    <!-- 订单列表 -->
                    <div id="orders-container" class="bg-white rounded-lg shadow-md overflow-hidden content-auto">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">订单编号</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">客户</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">商品</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">时间</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-list" class="bg-white divide-y divide-gray-200">
                                    <!-- 订单将通过JavaScript动态添加 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 空订单提示 -->
                        <div id="empty-orders" class="py-12 text-center text-gray-500 hidden">
                            <i class="fa fa-shopping-cart text-4xl mb-3"></i>
                            <p>暂无订单数据</p>
                        </div>
                    </div>
                    
                    <!-- 统计信息 -->
                    <div id="statistics" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6 animate-fadeIn animate-delay-300 content-auto">
                        <div class="bg-white rounded-lg shadow-md p-4">
                            <h3 class="text-sm font-medium text-gray-500 mb-1">今日营业额</h3>
                            <p id="today-revenue" class="text-2xl font-bold text-primary">¥0.00</p>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-md p-4">
                            <h3 class="text-sm font-medium text-gray-500 mb-1">总订单数</h3>
                            <p id="total-orders" class="text-2xl font-bold text-primary">0</p>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-md p-4">
                            <h3 class="text-sm font-medium text-gray-500 mb-1">总收入</h3>
                            <p id="total-revenue" class="text-2xl font-bold text-primary">¥0.00</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- 系统设置模态框 -->
        <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-5xl mx-4 animate-fadeIn">
                <div class="flex justify-between items-center border-b border-gray-200 px-6 py-4">
                    <h3 id="settings-modal-title" class="text-lg font-semibold text-gray-800">系统设置</h3>
                    <button id="close-settings-modal" class="text-gray-400 hover:text-gray-500"><i class="fa fa-times"></i></button>
                </div>
                <div class="px-0 py-0">
                    <div class="grid grid-cols-12">
                        <!-- 左侧导航 -->
                        <div class="col-span-4 md:col-span-3 bg-gray-50 border-r border-gray-200 p-4">
                            <nav id="settings-nav" class="space-y-2">
                                <button data-section="general" class="settings-nav-btn w-full text-left px-3 py-2 rounded-md border border-transparent hover:bg-white">一般设置</button>
                                <button data-section="operator" class="settings-nav-btn w-full text-left px-3 py-2 rounded-md border border-transparent hover:bg-white">操作者</button>
                                <button data-section="order" class="settings-nav-btn w-full text-left px-3 py-2 rounded-md border border-transparent hover:bg-white">订单管理</button>
                                <button data-section="history" class="settings-nav-btn w-full text-left px-3 py-2 rounded-md border border-transparent hover:bg-white">历史订单</button>
                                <button data-section="finance" class="settings-nav-btn w-full text-left px-3 py-2 rounded-md border border-transparent hover:bg-white">财务状况</button>
                                <button data-section="product" class="settings-nav-btn w-full text-left px-3 py-2 rounded-md border border-transparent hover:bg-white">商品管理</button>
                                <button data-section="customer" class="settings-nav-btn w-full text-left px-3 py-2 rounded-md border border-transparent hover:bg-white">顾客管理</button>
                                <button data-section="logs" class="settings-nav-btn w-full text-left px-3 py-2 rounded-md border border-transparent hover:bg-white">操作日志</button>
                                <button data-section="kpi" class="settings-nav-btn w-full text-left px-3 py-2 rounded-md border border-transparent hover:bg-white">核心KPI仪表盘</button>
                                <button id="settings-logout" class="w-full text-left px-3 py-2 rounded-md text-red-600 hover:bg-white">登出系统</button>
                            </nav>
                        </div>
                        <!-- 右侧内容 -->
                        <div class="col-span-8 md:col-span-9 p-6">
                            <div id="settings-content" class="space-y-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增订单模态框 -->
    <div id="new-order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 animate-fadeIn">
            <div class="flex justify-between items-center border-b border-gray-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">新增订单</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <form id="new-order-form" class="px-6 py-4 space-y-4">
                <div>
                    <label for="customer-select" class="block text-sm font-medium text-gray-700 mb-1">选择客户</label>
                    <select id="customer-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="">请选择现有客户</option>
                        <option value="_new">新增客户</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-700 mb-1">客户姓名</label>
                        <input type="text" id="customer-name" name="customerName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="customer-phone" class="block text-sm font-medium text-gray-700 mb-1">联系电话</label>
                        <input type="tel" id="customer-phone" name="customerPhone" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                </div>
                
                <div>
                    <label for="customer-address" class="block text-sm font-medium text-gray-700 mb-1">客户地址</label>
                    <input type="text" id="customer-address" name="customerAddress"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">商品</label>
                    <div id="items-container" class="space-y-3">
                        <div class="item-row grid grid-cols-12 gap-2">
                            <select class="category-select col-span-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">选择分类</option>
                                <option value="航空">航空</option>
                                <option value="公交">公交</option>
                                <option value="铁路">铁路</option>
                                <option value="航海">航海</option>
                                <option value="其他">其他</option>
                            </select>
                            <select class="item-select col-span-4 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">选择商品</option>
                                <!-- 商品选项将通过JavaScript动态添加 -->
                            </select>
                            <input type="number" class="item-quantity col-span-2 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" min="1" value="1">
                            <span class="item-price col-span-2 px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-700" readonly>¥0</span>
                            <button type="button" class="remove-item col-span-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition-all">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button type="button" id="add-item" class="mt-2 text-primary hover:text-blue-700 text-sm flex items-center">
                        <i class="fa fa-plus-circle mr-1"></i> 添加商品
                    </button>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">订单备注</label>
                    <textarea id="order-notes" name="notes" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <div class="flex items-center gap-3 mb-2">
                        <label class="inline-flex items-center text-sm text-gray-600">
                            <input type="checkbox" id="use-custom-total" class="mr-2">
                            不按商品價格結算
                        </label>
                        <input type="number" id="custom-total-input" class="w-36 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent disabled:bg-gray-100" min="0" step="0.01" placeholder="¥0.00" disabled>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <span class="font-medium">订单总价：</span>
                        <span id="order-total" class="text-xl font-bold text-primary">¥0.00</span>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-order" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-all">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-md transition-all">
                            提交订单
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <input id="import-combined-input" type="file" accept=".xls,.xlsx" class="hidden" />
    <div id="undo-toast" class="fixed bottom-4 right-4 bg-gray-900 text-white px-4 py-2 rounded-md shadow-lg hidden">
        <span>订单已删除</span>
        <button id="undo-delete-btn" class="ml-3 underline">还原</button>
    </div>
    <div id="payment-method-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 animate-fadeIn">
            <div class="flex justify-between items-center border-b border-gray-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">选择支付方式</h3>
                <button id="close-payment-method-modal" class="text-gray-400 hover:text-gray-500"><i class="fa fa-times"></i></button>
            </div>
            <div class="px-6 py-4 space-y-4">
                <input type="hidden" id="payment-order-id">
                <div>
                    <label for="payment-method-select" class="block text-sm font-medium text-gray-700 mb-1">支付方式</label>
                    <select id="payment-method-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="wechat">微信支付</option>
                        <option value="alipay">支付宝</option>
                        <option value="mpay">Mpay</option>
                        <option value="cash">现金</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="confirm-payment-method" class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-md transition-all">确定</button>
                </div>
            </div>
        </div>
    </div>
    <div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 animate-fadeIn">
            <div class="flex justify-between items-center border-b border-gray-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">收据</h3>
                <button id="close-receipt-modal" class="text-gray-400 hover:text-gray-500"><i class="fa fa-times"></i></button>
            </div>
            <div class="px-6 py-4 space-y-3">
                <div>
                    <p class="text-sm text-gray-500">客户信息</p>
                    <div class="grid grid-cols-2 gap-4 mt-1">
                        <p id="receipt-customer-name" class="font-medium"></p>
                        <p id="receipt-customer-phone" class="font-medium"></p>
                    </div>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500">地址</p>
                        <p id="receipt-customer-address" class="font-medium text-gray-700"></p>
                    </div>
                </div>
                <div>
                    <p class="text-sm text-gray-500">购买时间</p>
                    <p id="receipt-purchase-time" class="font-medium"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">结算时间</p>
                    <p id="receipt-settle-time" class="font-medium"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">支付方式</p>
                    <p id="receipt-payment-method" class="font-medium"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">购买产品</p>
                    <div id="receipt-items" class="space-y-1"></div>
                </div>
                <div class="pt-2 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">总金额：</span>
                        <span id="receipt-total" class="text-xl font-bold text-primary"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 订单详情模态框 -->
    <div id="order-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 animate-fadeIn">
            <div class="flex justify-between items-center border-b border-gray-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">订单详情</h3>
                <button id="close-detail-modal" class="text-gray-400 hover:text-gray-500">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <div class="px-6 py-4">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="text-sm text-gray-500">订单编号</p>
                        <p id="detail-order-id" class="font-medium"></p>
                    </div>
                    
                    <div>
                        <p class="text-sm text-gray-500">下单时间</p>
                        <p id="detail-order-time" class="font-medium"></p>
                    </div>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm text-gray-500">客户信息</p>
                    <div class="grid grid-cols-2 gap-4 mt-1">
                        <p id="detail-customer-name" class="font-medium"></p>
                        <p id="detail-customer-phone" class="font-medium"></p>
                    </div>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500">地址</p>
                        <p id="detail-customer-address" class="font-medium text-gray-700"></p>
                    </div>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm text-gray-500">订单商品</p>
                    <div id="detail-items-list" class="mt-1 space-y-2">
                        <!-- 商品列表将通过JavaScript动态添加 -->
                    </div>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm text-gray-500">订单备注</p>
                    <p id="detail-order-notes" class="mt-1 font-medium"></p>
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <span class="font-medium">订单总价：</span>
                        <span id="detail-order-total" class="text-xl font-bold text-primary"></span>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-500 mb-2">订单状态</p>
                        <div id="detail-order-status" class="inline-block px-3 py-1 rounded-full text-sm font-medium"></div>
                    </div>
                    
                    <div id="order-actions" class="flex flex-wrap gap-2">
                        <!-- 操作按钮将根据权限动态添加 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 订单管理模态框 -->
    <div id="order-management-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl mx-4 animate-fadeIn">
            <div class="flex justify-between items-center border-b border-gray-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">订单管理</h3>
                <button id="close-order-management-modal" class="text-gray-400 hover:text-gray-500">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <div class="px-6 py-4">
                <div class="mb-4">
                    <div class="relative">
                        <input type="text" id="search-orders-management" placeholder="搜索订单..."
                               class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                            <i class="fa fa-search"></i>
                        </span>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">订单编号</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">客户</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">商品</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">时间</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="orders-management-list" class="bg-white divide-y divide-gray-200">
                            <!-- 订单将通过JavaScript动态添加 -->
                        </tbody>
                    </table>
                </div>
                
                <div id="empty-orders-management" class="py-12 text-center text-gray-500 hidden">
                    <i class="fa fa-shopping-cart text-4xl mb-3"></i>
                    <p>暂无订单数据</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 编辑订单模态框 -->
    <div id="edit-order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 animate-fadeIn">
            <div class="flex justify-between items-center border-b border-gray-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">编辑订单</h3>
                <button id="close-edit-order-modal" class="text-gray-400 hover:text-gray-500">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <form id="edit-order-form" class="px-6 py-4 space-y-4">
                <input type="hidden" id="edit-order-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-customer-name" class="block text-sm font-medium text-gray-700 mb-1">客户姓名</label>
                        <input type="text" id="edit-customer-name" name="customerName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="edit-customer-phone" class="block text-sm font-medium text-gray-700 mb-1">联系电话</label>
                        <input type="tel" id="edit-customer-phone" name="customerPhone" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                </div>
                
                <div>
                    <label for="edit-customer-address" class="block text-sm font-medium text-gray-700 mb-1">客户地址</label>
                    <input type="text" id="edit-customer-address" name="customerAddress"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">订单商品</label>
                    <div id="edit-items-container" class="space-y-3">
                        <!-- 商品将通过JavaScript动态添加 -->
                    </div>
                </div>
                
                <div>
                    <label for="edit-order-status" class="block text-sm font-medium text-gray-700 mb-1">订单状态</label>
                    <select id="edit-order-status" name="status" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="pending">待处理</option>
                        <option value="completed">已完成</option>
                        <option value="cancelled">已取消</option>
                        <option value="soldOut">已售罄</option>
                    </select>
                </div>
                
                <div>
                    <label for="edit-order-notes" class="block text-sm font-medium text-gray-700 mb-1">订单备注</label>
                    <textarea id="edit-order-notes" name="notes" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <span class="font-medium">订单总价：</span>
                        <span id="edit-order-total" class="text-xl font-bold text-primary">¥0.00</span>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-edit-order" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-all">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-md transition-all">
                            保存修改
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 客户管理模态框 -->
    <div id="customer-management-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl mx-4 animate-fadeIn">
            <div class="flex justify-between items-center border-b border-gray-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">客户管理</h3>
                <button id="close-customer-management-modal" class="text-gray-400 hover:text-gray-500">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <div class="px-6 py-4">
                <div class="mb-4">
                    <div class="relative">
                        <input type="text" id="search-customers" placeholder="搜索客户..."
                               class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                            <i class="fa fa-search"></i>
                        </span>
                    </div>
                </div>
                <div class="mb-4 bg-gray-50 border border-gray-200 rounded-md p-4">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-2 items-end">
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">客户姓名</label>
                            <input id="quick-customer-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">联系电话</label>
                            <input id="quick-customer-phone" type="tel" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">客户地址</label>
                            <input id="quick-customer-address" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">客户备注</label>
                            <input id="quick-customer-notes" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">客户类型</label>
                            <select id="quick-customer-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="新客戶">新客戶</option>
                                <option value="常客">常客</option>
                                <option value="VIP">VIP</option>
                            </select>
                        </div>
                        <div class="md:col-span-1">
                            <button id="quick-add-customer-btn" class="w-full px-3 py-2 bg-primary hover:bg-blue-700 text-white rounded-md">新增</button>
                        </div>
                    </div>
                    <div id="quick-customer-suggestions" class="mt-2 space-y-2"></div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">客户姓名</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">联系电话</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">地址</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">订单数</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">消费总额</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">备注</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="customers-list" class="bg-white divide-y divide-gray-200">
                            <!-- 客户将通过JavaScript动态添加 -->
                        </tbody>
                    </table>
                </div>
                
                <div id="empty-customers" class="py-12 text-center text-gray-500 hidden">
                    <i class="fa fa-users text-4xl mb-3"></i>
                    <p>暂无客户数据</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 编辑客户模态框 -->
    <div id="edit-customer-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 animate-fadeIn">
            <div class="flex justify-between items-center border-b border-gray-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">编辑客户</h3>
                <button id="close-edit-customer-modal" class="text-gray-400 hover:text-gray-500">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <form id="edit-customer-form" class="px-6 py-4 space-y-4">
                <input type="hidden" id="edit-customer-phone-hidden">
                
                <div>
                    <label for="edit-customer-name-detail" class="block text-sm font-medium text-gray-700 mb-1">客户姓名</label>
                    <input type="text" id="edit-customer-name-detail" name="customerName" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div>
                    <label for="edit-customer-phone-detail" class="block text-sm font-medium text-gray-700 mb-1">联系电话</label>
                    <input type="tel" id="edit-customer-phone-detail" name="customerPhone" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div>
                    <label for="edit-customer-address" class="block text-sm font-medium text-gray-700 mb-1">客户地址</label>
                    <textarea id="edit-customer-address" name="address" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                </div>
                
                <div>
                    <label for="edit-customer-notes" class="block text-sm font-medium text-gray-700 mb-1">客户备注</label>
                    <textarea id="edit-customer-notes" name="notes" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-edit-customer" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-all">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-md transition-all">
                            保存修改
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 删除确认模态框 -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 animate-fadeIn">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">确认删除</h3>
            </div>
            
            <div class="px-6 py-4">
                <p class="mb-4">您确定要删除此订单吗？此操作不可撤销。</p>
                
                <div class="flex justify-end space-x-3">
                    <button id="cancel-delete" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-all">
                        取消
                    </button>
                    <button id="confirm-delete" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md transition-all">
                        确认删除
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 商品管理模态框 -->
    <div id="product-management-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl mx-4 animate-fadeIn">
            <div class="flex justify-between items-center border-b border-gray-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">商品管理</h3>
                <button id="close-product-management-modal" class="text-gray-400 hover:text-gray-500">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <div class="px-6 py-4">
                <div class="mb-4">
                    <div class="relative">
                        <input type="text" id="search-products" placeholder="搜索商品..."
                               class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                            <i class="fa fa-search"></i>
                        </span>
                    </div>
                    <div class="mt-3 text-right">
                        <button id="quick-add-product-btn" class="px-4 py-2 bg-info hover:bg-blue-700 text-white rounded-md transition-all">
                            <i class="fa fa-plus mr-1"></i> 快速新增商品
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">价格</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">描述</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="products-list" class="bg-white divide-y divide-gray-200">
                            <!-- 商品将通过JavaScript动态添加 -->
                        </tbody>
                    </table>
                </div>
                
                <div id="empty-products" class="py-12 text-center text-gray-500 hidden">
                    <i class="fa fa-cubes text-4xl mb-3"></i>
                    <p>暂无商品数据</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 编辑商品模态框 -->
    <div id="edit-product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 animate-fadeIn">
            <div class="flex justify-between items-center border-b border-gray-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">编辑商品</h3>
                <button id="close-edit-product-modal" class="text-gray-400 hover:text-gray-500">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <form id="edit-product-form" class="px-6 py-4 space-y-4">
                <input type="hidden" id="edit-product-original-name">
                <div>
                    <label for="edit-product-name" class="block text-sm font-medium text-gray-700 mb-1">商品名称</label>
                    <input type="text" id="edit-product-name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label for="edit-product-category" class="block text-sm font-medium text-gray-700 mb-1">商品分类</label>
                    <input type="text" id="edit-product-category" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label for="edit-product-price" class="block text-sm font-medium text-gray-700 mb-1">商品价格</label>
                    <input type="number" id="edit-product-price" min="0" step="0.01" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label for="edit-product-description" class="block text-sm font-medium text-gray-700 mb-1">商品描述</label>
                    <textarea id="edit-product-description" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                </div>
                <div class="pt-4 border-t border-gray-200">
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-edit-product" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-all">取消</button>
                        <button type="submit" class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-md transition-all">保存修改</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 财务管理模态框 -->
    <div id="financial-management-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl mx-4 animate-fadeIn">
            <div class="flex justify-between items-center border-b border-gray-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">财务管理</h3>
                <button id="close-financial-management-modal" class="text-gray-400 hover:text-gray-500"><i class="fa fa-times"></i></button>
            </div>
            <div class="px-6 py-4 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="adjust-amount" class="block text-sm font-medium text-gray-700 mb-1">调整金额（收入填正数，支出填负数）</label>
                        <input type="number" id="adjust-amount" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" step="0.01">
                    </div>
                    <div>
                        <label for="adjust-reason" class="block text-sm font-medium text-gray-700 mb-1">输入原因</label>
                        <input type="text" id="adjust-reason" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="例如：促销补贴、退款等">
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="add-adjustment-btn" class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-md transition-all">保存调整</button>
                    <button id="view-transactions-btn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-md transition-all">查看所有交易记录</button>
                </div>
                <div class="pt-4 border-t border-gray-200">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">数据清除</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="md:col-span-2">
                            <input type="text" id="clear-finance-confirm" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="请输入 清除 或 reset">
                        </div>
                        <div>
                            <button id="clear-finance-btn" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md transition-all">删除全部总支出与总收入</button>
                        </div>
                    </div>
                </div>
                <div class="pt-4 border-t border-gray-200">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">交易记录</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">时间</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作者</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">原因</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-list" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="empty-transactions" class="py-12 text-center text-gray-500 hidden">
                        <i class="fa fa-file-text-o text-4xl mb-3"></i>
                        <p>暂无交易记录</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 操作者与日志模态框 -->
    <div id="operator-logs-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl mx-4 animate-fadeIn">
            <div class="flex justify-between items-center border-b border-gray-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">操作者与日志</h3>
                <button id="close-operator-logs-modal" class="text-gray-400 hover:text-gray-500"><i class="fa fa-times"></i></button>
            </div>
            <div class="px-6 py-4 space-y-4">
                <div>
                    <label for="operator-select" class="block text-sm font-medium text-gray-700 mb-1">选择操作者</label>
                    <select id="operator-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="CTPP-01">CTPP-01</option>
                        <option value="CTPP-02">CTPP-02</option>
                        <option value="CTPP-03">CTPP-03</option>
                    </select>
                </div>
                <div class="pt-2 border-t border-gray-200">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">操作日志</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">时间</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作者</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">详情</th>
                                </tr>
                            </thead>
                            <tbody id="operation-logs-list" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="empty-operation-logs" class="py-12 text-center text-gray-500 hidden">
                        <i class="fa fa-list-alt text-4xl mb-3"></i>
                        <p>暂无操作日志</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 新增商品模态框 -->
    <div id="new-product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 animate-fadeIn">
            <div class="flex justify-between items-center border-b border-gray-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">新增商品</h3>
                <button id="close-product-modal" class="text-gray-400 hover:text-gray-500">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <form id="new-product-form" class="px-6 py-4 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-700 mb-1">商品名称 <span class="text-red-500">*</span></label>
                        <input type="text" id="product-name" name="productName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="product-price" class="block text-sm font-medium text-gray-700 mb-1">商品价格 <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                ¥
                            </span>
                            <input type="number" id="product-price" name="productPrice" min="0.01" step="0.01" required
                                   class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>
                </div>
                
                <div>
                    <label for="product-category" class="block text-sm font-medium text-gray-700 mb-1">商品分类 <span class="text-red-500">*</span></label>
                    <select id="product-category" name="productCategory" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="">选择分类</option>
                        <option value="航空">航空</option>
                        <option value="公交">公交</option>
                        <option value="铁路">铁路</option>
                        <option value="航海">航海</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                
                <div>
                    <label for="product-description" class="block text-sm font-medium text-gray-700 mb-1">商品描述</label>
                    <textarea id="product-description" name="productDescription" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-product" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-all">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-md transition-all">
                            保存商品
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    

    <script>
        // 模拟数据
        const users = [
            {
                username: "admin",
                password: "abcd1234",
                permissions: ["view", "add"] // 仅查看和新增权限
            },
            {
                username: "CAAC_01",
                password: "Carter0502",
                permissions: ["view", "add", "edit", "delete"] // 全部权限
            },
            {
                username: "CarterChan",
                password: "Carter0502",
                permissions: ["view", "add", "edit", "delete"] // 全部权限
            }
        ];
        
        // 商品数据（空）
        let products = [];
        
        // 商品分类
        const categories = [
            { id: "staple", name: "主食" },
            { id: "snack", name: "小吃" },
            { id: "drink", name: "饮料" },
            { id: "dessert", name: "甜点" },
            { id: "other", name: "其他" }
        ];
        
        // 初始化订单数据（空）
        let orders = [];
        let extraCustomers = [];
        
        // 当前登录用户
        let currentUser = null;
        
        // 当前筛选条件
        let currentFilter = "all";
        
        // 当前搜索关键词
        let currentSearch = "";
        
        // 当前选中的订单ID（用于删除确认）
        let selectedOrderId = null;
        
        // DOM 元素
        const loginPage = document.getElementById('login-page');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const currentUserEl = document.getElementById('current-user');
        const mobileUsernameEl = document.getElementById('mobile-username');
        const pressToShowPasswordBtn = document.getElementById('press-to-show-password');
        const passwordInputEl = document.getElementById('password');
        const rememberMeCheckbox = document.getElementById('remember-me');
        const newOrderBtn = document.getElementById('new-order-btn');
        const newProductBtn = document.getElementById('new-product-btn');
        const newOrderModal = document.getElementById('new-order-modal');
        const newProductModal = document.getElementById('new-product-modal');
        const closeModal = document.getElementById('close-modal');
        const closeProductModal = document.getElementById('close-product-modal');
        const newOrderForm = document.getElementById('new-order-form');
        const newProductForm = document.getElementById('new-product-form');
        const cancelOrder = document.getElementById('cancel-order');
        const cancelProduct = document.getElementById('cancel-product');
        const addItemBtn = document.getElementById('add-item');
        const itemsContainer = document.getElementById('items-container');
        const orderTotalEl = document.getElementById('order-total');
        const useCustomTotalCheckbox = document.getElementById('use-custom-total');
        const customTotalInput = document.getElementById('custom-total-input');
        const ordersList = document.getElementById('orders-list');
        const emptyOrders = document.getElementById('empty-orders');
        const orderCountEl = document.getElementById('order-count');
        const searchOrders = document.getElementById('search-orders');
        const filterBtns = document.querySelectorAll('.filter-btn');
        const orderDetailModal = document.getElementById('order-detail-modal');
        const closeDetailModal = document.getElementById('close-detail-modal');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const cancelDelete = document.getElementById('cancel-delete');
        const confirmDelete = document.getElementById('confirm-delete');
        const todayRevenueEl = document.getElementById('today-revenue');
        const totalOrdersEl = document.getElementById('total-orders');
        const totalRevenueEl = document.getElementById('total-revenue');
        let transactions = [];
        let operationLogs = [];
        let currentOperator = 'CTPP-01';
        const paymentMethodModal = document.getElementById('payment-method-modal');
        const paymentOrderIdInput = document.getElementById('payment-order-id');
        const paymentMethodSelect = document.getElementById('payment-method-select');
        const closePaymentMethodModal = document.getElementById('close-payment-method-modal');
        const confirmPaymentMethodBtn = document.getElementById('confirm-payment-method');
        const receiptModal = document.getElementById('receipt-modal');
        const closeReceiptModal = document.getElementById('close-receipt-modal');
        const receiptPurchaseTime = document.getElementById('receipt-purchase-time');
        const receiptSettleTime = document.getElementById('receipt-settle-time');
        const receiptPaymentMethod = document.getElementById('receipt-payment-method');
        const receiptCustomerName = document.getElementById('receipt-customer-name');
        const receiptCustomerPhone = document.getElementById('receipt-customer-phone');
        const receiptCustomerAddress = document.getElementById('receipt-customer-address');
        const receiptItems = document.getElementById('receipt-items');
        const receiptTotal = document.getElementById('receipt-total');
        
        // 设置相关元素
        const settingsDropdownContainer = document.getElementById('settings-dropdown-container');
        const settingsDropdownBtn = document.getElementById('settings-dropdown-btn');
        const settingsDropdown = document.getElementById('settings-dropdown');
        const orderManagementLink = document.getElementById('order-management-link');
        const customerManagementLink = document.getElementById('customer-management-link');
        const productManagementLink = document.getElementById('product-management-link');
        const financialManagementLink = document.getElementById('financial-management-link');
        const operatorLogsLink = document.getElementById('operator-logs-link');
        const exportOrdersLink = document.getElementById('export-orders-link');
        const exportCustomersLink = document.getElementById('export-customers-link');
        const exportCombinedLink = document.getElementById('export-combined-link');
        const importCombinedLink = document.getElementById('import-combined-link');
        const logoutLink = document.getElementById('logout-link');
        const settingsModal = document.getElementById('settings-modal');
        const settingsContent = document.getElementById('settings-content');
        const settingsNav = document.getElementById('settings-nav');
        const closeSettingsModal = document.getElementById('close-settings-modal');
        const settingsLogout = document.getElementById('settings-logout');
        const appTitleEl = document.getElementById('app-title');
        const welcomeLabelEl = document.getElementById('welcome-label');
        const settingsButtonTextEl = document.getElementById('settings-button-text');
        const settingsModalTitleEl = document.getElementById('settings-modal-title');
        const loginPageTitleEl = document.getElementById('login-page-title');
        const loginSubtitleEl = document.getElementById('login-subtitle');
        const labelUsernameEl = document.getElementById('label-username');
        const labelPasswordEl = document.getElementById('label-password');
        const loginSubmitBtn = document.getElementById('login-submit-btn');
        
        // 管理功能相关元素
        const orderManagementModal = document.getElementById('order-management-modal');
        const customerManagementModal = document.getElementById('customer-management-modal');
        const closeOrderManagementModal = document.getElementById('close-order-management-modal');
        const closeCustomerManagementModal = document.getElementById('close-customer-management-modal');
        const searchOrdersManagement = document.getElementById('search-orders-management');
        const ordersManagementList = document.getElementById('orders-management-list');
        const emptyOrdersManagement = document.getElementById('empty-orders-management');
        const searchCustomers = document.getElementById('search-customers');
        const customersList = document.getElementById('customers-list');
        const emptyCustomers = document.getElementById('empty-customers');
        const quickCustomerName = document.getElementById('quick-customer-name');
        const quickCustomerPhone = document.getElementById('quick-customer-phone');
        const quickCustomerAddress = document.getElementById('quick-customer-address');
        const quickCustomerNotes = document.getElementById('quick-customer-notes');
        const quickCustomerType = document.getElementById('quick-customer-type');
        const quickCustomerSuggestions = document.getElementById('quick-customer-suggestions');
        const quickAddCustomerBtn = document.getElementById('quick-add-customer-btn');
        const productManagementModal = document.getElementById('product-management-modal');
        const closeProductManagementModal = document.getElementById('close-product-management-modal');
        const productsList = document.getElementById('products-list');
        const emptyProducts = document.getElementById('empty-products');
        const searchProducts = document.getElementById('search-products');
        const quickAddProductBtn = document.getElementById('quick-add-product-btn');
        const editProductModal = document.getElementById('edit-product-modal');
        const closeEditProductModal = document.getElementById('close-edit-product-modal');
        const editProductForm = document.getElementById('edit-product-form');
        const cancelEditProduct = document.getElementById('cancel-edit-product');
        const editProductOriginalName = document.getElementById('edit-product-original-name');
        const editProductName = document.getElementById('edit-product-name');
        const editProductCategory = document.getElementById('edit-product-category');
        const editProductPrice = document.getElementById('edit-product-price');
        const editProductDescription = document.getElementById('edit-product-description');
        const financialManagementModal = document.getElementById('financial-management-modal');
        const closeFinancialManagementModal = document.getElementById('close-financial-management-modal');
        const adjustAmountInput = document.getElementById('adjust-amount');
        const adjustReasonInput = document.getElementById('adjust-reason');
        const addAdjustmentBtn = document.getElementById('add-adjustment-btn');
        const viewTransactionsBtn = document.getElementById('view-transactions-btn');
        const clearFinanceConfirmInput = document.getElementById('clear-finance-confirm');
        const clearFinanceBtn = document.getElementById('clear-finance-btn');
        const transactionsList = document.getElementById('transactions-list');
        const emptyTransactions = document.getElementById('empty-transactions');
        const operatorLogsModal = document.getElementById('operator-logs-modal');
        const closeOperatorLogsModal = document.getElementById('close-operator-logs-modal');
        const operatorSelect = document.getElementById('operator-select');
        const operationLogsList = document.getElementById('operation-logs-list');
        const emptyOperationLogs = document.getElementById('empty-operation-logs');
        
        // 编辑订单相关元素
        const editOrderModal = document.getElementById('edit-order-modal');
        const closeEditOrderModal = document.getElementById('close-edit-order-modal');
        const editOrderForm = document.getElementById('edit-order-form');
        const cancelEditOrder = document.getElementById('cancel-edit-order');
        const editOrderId = document.getElementById('edit-order-id');
        const editCustomerName = document.getElementById('edit-customer-name');
        const editCustomerPhone = document.getElementById('edit-customer-phone');
        const editOrderStatus = document.getElementById('edit-order-status');
        const editOrderNotes = document.getElementById('edit-order-notes');
        const editItemsContainer = document.getElementById('edit-items-container');
        const editOrderTotal = document.getElementById('edit-order-total');
        
        // 编辑客户相关元素
        const editCustomerModal = document.getElementById('edit-customer-modal');
        const closeEditCustomerModal = document.getElementById('close-edit-customer-modal');
        const editCustomerForm = document.getElementById('edit-customer-form');
        const cancelEditCustomer = document.getElementById('cancel-edit-customer');
        const editCustomerPhoneHidden = document.getElementById('edit-customer-phone-hidden');
        const editCustomerNameDetail = document.getElementById('edit-customer-name-detail');
        const editCustomerPhoneDetail = document.getElementById('edit-customer-phone-detail');
        const editCustomerAddress = document.getElementById('edit-customer-address');
        const editCustomerNotes = document.getElementById('edit-customer-notes');
        

        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 点击设置按钮打开系统设置模态框
            settingsDropdownBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showSettingsModal('general');
            });
            
            // 关闭旧的下拉菜单交互（改用系统设置模态）
            // 尝试从本地存储加载数据
            loadData();
            ensureDeviceId();
            attemptAutoLogin();
            applyTheme();
            applyLanguage();
            
            // 渲染统计信息
            updateStatistics();
            
            // 登录表单提交
            loginForm.addEventListener('submit', handleLogin);
            
            // 退出登录
            logoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                handleLogout();
            });
            closeSettingsModal.addEventListener('click', () => settingsModal.classList.add('hidden'));
            settingsLogout.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); settingsModal.classList.add('hidden'); });
            settingsNav.querySelectorAll('.settings-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const section = btn.getAttribute('data-section');
                    showSettingsModal(section);
                });
            });

            if (pressToShowPasswordBtn && passwordInputEl) {
                const showPwd = () => { passwordInputEl.type = 'text'; };
                const hidePwd = () => { passwordInputEl.type = 'password'; };
                pressToShowPasswordBtn.addEventListener('mousedown', showPwd);
                pressToShowPasswordBtn.addEventListener('mouseup', hidePwd);
                pressToShowPasswordBtn.addEventListener('mouseleave', hidePwd);
                pressToShowPasswordBtn.addEventListener('touchstart', (e) => { e.preventDefault(); showPwd(); }, { passive: false });
                pressToShowPasswordBtn.addEventListener('touchend', hidePwd);
                pressToShowPasswordBtn.addEventListener('touchcancel', hidePwd);
            }
            
            // 订单管理
            orderManagementLink.addEventListener('click', (e) => {
                e.preventDefault();
                showOrderManagement();
            });
            
            // 客户管理
            customerManagementLink.addEventListener('click', (e) => {
                e.preventDefault();
                showCustomerManagement();
            });
            // 商品管理
            productManagementLink.addEventListener('click', (e) => {
                e.preventDefault();
                showProductManagement();
            });
            // 财务管理
            financialManagementLink.addEventListener('click', (e) => {
                e.preventDefault();
                showFinancialManagement();
            });
            // 操作者与日志
            operatorLogsLink.addEventListener('click', (e) => {
                e.preventDefault();
                showOperatorLogs();
            });
            
            // 关闭订单管理模态框
            closeOrderManagementModal.addEventListener('click', () => {
                orderManagementModal.classList.add('hidden');
            });
            
            // 关闭客户管理模态框
            closeCustomerManagementModal.addEventListener('click', () => {
                customerManagementModal.classList.add('hidden');
            });
            // 关闭商品管理模态框
            closeProductManagementModal.addEventListener('click', () => {
                productManagementModal.classList.add('hidden');
            });
            // 关闭财务管理模态框
            closeFinancialManagementModal.addEventListener('click', () => {
                financialManagementModal.classList.add('hidden');
            });
            // 关闭操作者与日志模态框
            closeOperatorLogsModal.addEventListener('click', () => {
                operatorLogsModal.classList.add('hidden');
            });
            
            // 搜索订单管理
            searchOrdersManagement.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                renderOrdersManagement(searchTerm);
            });
            
            // 搜索客户
            searchCustomers.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                renderCustomers(searchTerm);
            });
            // 搜索商品
            searchProducts.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                renderProductsManagement(searchTerm);
            });
            if (quickAddCustomerBtn) {
                quickAddCustomerBtn.addEventListener('click', handleQuickAddCustomer);
            }
            if (quickCustomerName) {
                quickCustomerName.addEventListener('input', () => renderQuickCustomerSuggestions(getQuickTerm()));
            }
            if (quickCustomerPhone) {
                quickCustomerPhone.addEventListener('input', () => renderQuickCustomerSuggestions(getQuickTerm()));
            }
            if (quickCustomerAddress) {
                quickCustomerAddress.addEventListener('input', () => renderQuickCustomerSuggestions(getQuickTerm()));
            }
            if (quickCustomerNotes) {
                quickCustomerNotes.addEventListener('input', () => renderQuickCustomerSuggestions(getQuickTerm()));
            }
            function formatDate(dtStr) {
                const d = new Date(dtStr);
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const da = String(d.getDate()).padStart(2, '0');
                const hh = String(d.getHours()).padStart(2, '0');
                const mm = String(d.getMinutes()).padStart(2, '0');
                const ss = String(d.getSeconds()).padStart(2, '0');
                return `${y}-${m}-${da} ${hh}:${mm}:${ss}`;
            }
            function loadScriptSequential(urls) {
                return new Promise((resolve, reject) => {
                    const tryNext = (i) => {
                        if (i >= urls.length) { reject(new Error('load failed')); return; }
                        const s = document.createElement('script');
                        s.src = urls[i];
                        s.onload = () => resolve();
                        s.onerror = () => { s.remove(); tryNext(i + 1); };
                        document.head.appendChild(s);
                    };
                    tryNext(0);
                });
            }
            async function ensureXLSXLoaded() {
                if (typeof XLSX !== 'undefined') return true;
                const urls = [
                    'https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js',
                    'https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js'
                ];
                try { await loadScriptSequential(urls); } catch (e) { return false; }
                return typeof XLSX !== 'undefined';
            }
            function downloadBlob(filename, mime, content) {
                const blob = new Blob([content], { type: mime });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            }
            function toCSVRow(arr) {
                return arr.map(v => {
                    const s = String(v ?? '');
                    const needsQuote = /[",\n]/.test(s);
                    const escaped = s.replace(/"/g, '""');
                    return needsQuote ? `"${escaped}"` : escaped;
                }).join(',');
            }
            function buildExcelHTML(headers, rows) {
                const thead = `<thead><tr>${headers.map(h => `<th>${String(h)}</th>`).join('')}</tr></thead>`;
                const tbody = `<tbody>${rows.map(r => `<tr>${r.map(c => `<td>${String(c ?? '')}</td>`).join('')}</tr>`).join('')}</tbody>`;
                return `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>table{border-collapse:collapse}th,td{border:1px solid #ccc;padding:4px}</style></head><body><table>${thead}${tbody}</table></body></html>`;
            }
            function exportOrdersToCSV() {
                const headers = ['订单编号','客户姓名','联系电话','客户地址','商品明细','金额','状态','创建时间','更新时间','备注'];
                const rows = orders.map(o => {
                    const itemsText = (o.items || []).map(i => `${i.name} x${i.quantity}`).join(' | ');
                    return [
                        o.id || '',
                        o.customerName || '',
                        o.customerPhone || '',
                        o.customerAddress || '',
                        itemsText,
                        typeof o.totalAmount === 'number' ? o.totalAmount : '',
                        o.status || '',
                        o.createdAt ? formatDate(o.createdAt) : '',
                        o.updatedAt ? formatDate(o.updatedAt) : '',
                        o.notes || ''
                    ];
                });
                const csv = [headers, ...rows].map(toCSVRow).join('\n');
                const now = new Date();
                const fname = `orders_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.csv`;
                downloadBlob(fname, 'text/csv;charset=utf-8', '\ufeff' + csv);
            }
            function exportOrdersToXLS() {
                const headers = ['订单编号','客户姓名','联系电话','客户地址','商品明细','金额','状态','创建时间','更新时间','备注'];
                const rows = orders.map(o => {
                    const itemsText = (o.items || []).map(i => `${i.name} x${i.quantity}`).join(' | ');
                    return [
                        o.id || '',
                        o.customerName || '',
                        o.customerPhone || '',
                        o.customerAddress || '',
                        itemsText,
                        typeof o.totalAmount === 'number' ? o.totalAmount : '',
                        o.status || '',
                        o.createdAt ? formatDate(o.createdAt) : '',
                        o.updatedAt ? formatDate(o.updatedAt) : '',
                        o.notes || ''
                    ];
                });
                const html = buildExcelHTML(headers, rows);
                const now = new Date();
                const fname = `orders_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.xls`;
                downloadBlob(fname, 'application/vnd.ms-excel', html);
            }
            function exportCustomersToCSV() {
                const customersMap = new Map();
                orders.forEach(order => {
                    const key = order.customerPhone;
                    if (!key) return;
                    if (!customersMap.has(key)) {
                        customersMap.set(key, {
                            name: order.customerName || '',
                            phone: order.customerPhone || '',
                            address: order.customerAddress || '',
                            orderCount: 0,
                            totalSpent: 0
                        });
                    }
                    const c = customersMap.get(key);
                    c.orderCount += 1;
                    c.totalSpent += (order.totalAmount || 0);
                    if (order.customerAddress) c.address = order.customerAddress;
                });
                const headers = ['客户姓名','联系电话','客户地址','订单数','总消费'];
                const rows = Array.from(customersMap.values()).map(c => [
                    c.name,
                    c.phone,
                    c.address,
                    c.orderCount,
                    Number(c.totalSpent.toFixed(2))
                ]);
                const csv = [headers, ...rows].map(toCSVRow).join('\n');
                const now = new Date();
                const fname = `customers_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.csv`;
                downloadBlob(fname, 'text/csv;charset=utf-8', '\ufeff' + csv);
            }
            function exportCustomersToXLS() {
                const customersMap = new Map();
                orders.forEach(order => {
                    const key = order.customerPhone;
                    if (!key) return;
                    if (!customersMap.has(key)) {
                        customersMap.set(key, {
                            name: order.customerName || '',
                            phone: order.customerPhone || '',
                            address: order.customerAddress || '',
                            orderCount: 0,
                            totalSpent: 0
                        });
                    }
                    const c = customersMap.get(key);
                    c.orderCount += 1;
                    c.totalSpent += (order.totalAmount || 0);
                    if (order.customerAddress) c.address = order.customerAddress;
                });
                const headers = ['客户姓名','联系电话','客户地址','订单数','总消费'];
                const rows = Array.from(customersMap.values()).map(c => [
                    c.name,
                    c.phone,
                    c.address,
                    c.orderCount,
                    Number(c.totalSpent.toFixed(2))
                ]);
                const html = buildExcelHTML(headers, rows);
                const now = new Date();
                const fname = `customers_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.xls`;
                downloadBlob(fname, 'application/vnd.ms-excel', html);
            }
            function buildExcelWorkbookHTML(sheets) {
                const headerXml = `<!DOCTYPE html><html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets>${sheets.map(s => `<x:ExcelWorksheet><x:Name>${s.name}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet>`).join('')}</x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--><style>table{border-collapse:collapse}th,td{border:1px solid #ccc;padding:4px}</style></head><body>`;
                const tables = sheets.map(s => {
                    const thead = `<thead><tr>${s.headers.map(h => `<th>${String(h)}</th>`).join('')}</tr></thead>`;
                    const tbody = `<tbody>${s.rows.map(r => `<tr>${r.map(c => `<td>${String(c ?? '')}</td>`).join('')}</tr>`).join('')}</tbody>`;
                    return `<table>${thead}${tbody}</table>`;
                }).join('');
                const tail = `</body></html>`;
                return headerXml + tables + tail;
            }
            async function exportCombinedToXLSX() {
                const ok = await ensureXLSXLoaded();
                if (!ok) {
                    const ordersHeaders = ['订单编号','客户姓名','联系电话','客户地址','商品明细','金额','状态','创建时间','更新时间','备注'];
                    const ordersRows = orders.map(o => {
                        const itemsText = (o.items || []).map(i => `${i.name} x${i.quantity}`).join(' | ');
                        return [
                            o.id || '',
                            o.customerName || '',
                            o.customerPhone || '',
                            o.customerAddress || '',
                            itemsText,
                            typeof o.totalAmount === 'number' ? o.totalAmount : '',
                            o.status || '',
                            o.createdAt ? formatDate(o.createdAt) : '',
                            o.updatedAt ? formatDate(o.updatedAt) : '',
                            o.notes || ''
                        ];
                    });
                    const customersMap = new Map();
                    orders.forEach(order => {
                        const key = order.customerPhone;
                        if (!key) return;
                        if (!customersMap.has(key)) {
                            customersMap.set(key, {
                                name: order.customerName || '',
                                phone: order.customerPhone || '',
                                address: order.customerAddress || '',
                                orderCount: 0,
                                totalSpent: 0
                            });
                        }
                        const c = customersMap.get(key);
                        c.orderCount += 1;
                        c.totalSpent += (order.totalAmount || 0);
                        if (order.customerAddress) c.address = order.customerAddress;
                    });
                    const customersHeaders = ['客户姓名','联系电话','客户地址','订单数','总消费'];
                    const customersRows = Array.from(customersMap.values()).map(c => [
                        c.name,
                        c.phone,
                        c.address,
                        c.orderCount,
                        Number(c.totalSpent.toFixed(2))
                    ]);
                    const html = buildExcelWorkbookHTML([
                        { name: '订单', headers: ordersHeaders, rows: ordersRows },
                        { name: '客户', headers: customersHeaders, rows: customersRows }
                    ]);
                    const now = new Date();
                    const fname = `data_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.xls`;
                    downloadBlob(fname, 'application/vnd.ms-excel', html);
                    return;
                }
                const ordersHeaders = ['订单编号','客户姓名','联系电话','客户地址','商品明细','金额','状态','创建时间','更新时间','备注'];
                const ordersRows = orders.map(o => {
                    const itemsText = (o.items || []).map(i => `${i.name} x${i.quantity}`).join(' | ');
                    return [
                        o.id || '',
                        o.customerName || '',
                        o.customerPhone || '',
                        o.customerAddress || '',
                        itemsText,
                        typeof o.totalAmount === 'number' ? o.totalAmount : '',
                        o.status || '',
                        o.createdAt ? formatDate(o.createdAt) : '',
                        o.updatedAt ? formatDate(o.updatedAt) : '',
                        o.notes || ''
                    ];
                });
                const customersMap = new Map();
                orders.forEach(order => {
                    const key = order.customerPhone;
                    if (!key) return;
                    if (!customersMap.has(key)) {
                        customersMap.set(key, {
                            name: order.customerName || '',
                            phone: order.customerPhone || '',
                            address: order.customerAddress || '',
                            orderCount: 0,
                            totalSpent: 0
                        });
                    }
                    const c = customersMap.get(key);
                    c.orderCount += 1;
                    c.totalSpent += (order.totalAmount || 0);
                    if (order.customerAddress) c.address = order.customerAddress;
                });
                const customersHeaders = ['客户姓名','联系电话','客户地址','订单数','总消费'];
                const customersRows = Array.from(customersMap.values()).map(c => [
                    c.name,
                    c.phone,
                    c.address,
                    c.orderCount,
                    Number(c.totalSpent.toFixed(2))
                ]);
                const wb = XLSX.utils.book_new();
                const wsOrders = XLSX.utils.aoa_to_sheet([ordersHeaders, ...ordersRows]);
                const wsCustomers = XLSX.utils.aoa_to_sheet([customersHeaders, ...customersRows]);
                XLSX.utils.book_append_sheet(wb, wsOrders, '订单');
                XLSX.utils.book_append_sheet(wb, wsCustomers, '客户');
                const now = new Date();
                const fname = `data_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.xlsx`;
                XLSX.writeFile(wb, fname);
            }
            function parseHTMLTables(text) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const tables = Array.from(doc.querySelectorAll('table'));
                return tables.map(tbl => {
                    const rows = Array.from(tbl.querySelectorAll('tr')).map(tr => Array.from(tr.querySelectorAll('th,td')).map(td => td.textContent.trim()));
                    return rows;
                });
            }
            function rowsToObjectsByHeader(rows) {
                if (!rows || rows.length === 0) return [];
                const headers = rows[0];
                return rows.slice(1).map(r => {
                    const obj = {};
                    headers.forEach((h, i) => { obj[h] = r[i]; });
                    return obj;
                });
            }
            function mergeImportedOrders(list) {
                list.forEach(o => {
                    const id = o['订单编号'] || o['id'] || '';
                    const existingIndex = orders.findIndex(x => x.id === id);
                    const itemsText = o['商品明细'] || '';
                    const items = String(itemsText).split('|').map(s => s.trim()).filter(Boolean).map(seg => {
                        const m = seg.match(/^(.*) x(\d+)$/);
                        if (!m) return null;
                        const name = m[1].trim();
                        const quantity = parseInt(m[2], 10) || 0;
                        const product = products.find(p => p.name === name);
                        const price = product ? product.price : 0;
                        return { name, quantity, price };
                    }).filter(Boolean);
                    const totalAmount = parseFloat(o['金额']) || 0;
                    const createdAt = o['创建时间'] ? new Date(o['创建时间']).toISOString() : new Date().toISOString();
                    const updatedAt = o['更新时间'] ? new Date(o['更新时间']).toISOString() : createdAt;
                    const record = {
                        id: id || ("ORD" + Date.now().toString().slice(-6)),
                        customerName: o['客户姓名'] || '',
                        customerPhone: o['联系电话'] || '',
                        customerAddress: o['客户地址'] || '',
                        items,
                        status: o['状态'] || 'pending',
                        notes: o['备注'] || '',
                        totalAmount,
                        createdAt,
                        updatedAt
                    };
                    if (existingIndex >= 0) {
                        orders[existingIndex] = record;
                    } else {
                        orders.unshift(record);
                    }
                });
            }
            function mergeImportedCustomers(list) {
                const map = new Map();
                list.forEach(c => {
                    const phone = c['联系电话'] || '';
                    if (!phone) return;
                    const name = c['客户姓名'] || '';
                    const address = c['客户地址'] || '';
                    map.set(phone, { name, address });
                });
                orders = orders.map(o => {
                    const info = map.get(o.customerPhone);
                    if (!info) return o;
                    return { ...o, customerName: info.name || o.customerName, customerAddress: info.address || o.customerAddress };
                });
            }
            async function importCombinedFromFile(file) {
                const ok = await ensureXLSXLoaded();
                if (ok) {
                    const buf = await file.arrayBuffer();
                    const wb = XLSX.read(buf, { type: 'array' });
                    const ordersSheet = wb.Sheets['订单'] || wb.Sheets[wb.SheetNames[0]];
                    const customersSheet = wb.Sheets['客户'] || wb.Sheets[wb.SheetNames[1]];
                    if (ordersSheet) {
                        const rows = XLSX.utils.sheet_to_json(ordersSheet, { header: 1 });
                        const list = rowsToObjectsByHeader(rows);
                        mergeImportedOrders(list);
                    }
                    if (customersSheet) {
                        const rows = XLSX.utils.sheet_to_json(customersSheet, { header: 1 });
                        const list = rowsToObjectsByHeader(rows);
                        mergeImportedCustomers(list);
                    }
                } else {
                    const text = await file.text();
                    const tables = parseHTMLTables(text);
                    if (tables[0]) {
                        const list = rowsToObjectsByHeader(tables[0]);
                        mergeImportedOrders(list);
                    }
                    if (tables[1]) {
                        const list = rowsToObjectsByHeader(tables[1]);
                        mergeImportedCustomers(list);
                    }
                }
                saveData();
                renderOrders();
                updateStatistics();
                alert('数据已导入');
            }
            async function exportOrdersToXLSX() {
                const ok = await ensureXLSXLoaded();
                if (!ok) {
                    alert('离线环境：XLSX 未加载，已改用 Excel（.xls）导出');
                    exportOrdersToXLS();
                    return;
                }
                const headers = ['订单编号','客户姓名','联系电话','客户地址','商品明细','金额','状态','创建时间','更新时间','备注'];
                const rows = orders.map(o => {
                    const itemsText = (o.items || []).map(i => `${i.name} x${i.quantity}`).join(' | ');
                    return [
                        o.id || '',
                        o.customerName || '',
                        o.customerPhone || '',
                        o.customerAddress || '',
                        itemsText,
                        typeof o.totalAmount === 'number' ? o.totalAmount : '',
                        o.status || '',
                        o.createdAt ? formatDate(o.createdAt) : '',
                        o.updatedAt ? formatDate(o.updatedAt) : '',
                        o.notes || ''
                    ];
                });
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
                XLSX.utils.book_append_sheet(wb, ws, '订单');
                const now = new Date();
                const fname = `orders_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.xlsx`;
                XLSX.writeFile(wb, fname);
            }
            async function exportCustomersToXLSX() {
                const ok = await ensureXLSXLoaded();
                if (!ok) {
                    alert('离线环境：XLSX 未加载，已改用 Excel（.xls）导出');
                    exportCustomersToXLS();
                    return;
                }
                const customersMap = new Map();
                orders.forEach(order => {
                    const key = order.customerPhone;
                    if (!key) return;
                    if (!customersMap.has(key)) {
                        customersMap.set(key, {
                            name: order.customerName || '',
                            phone: order.customerPhone || '',
                            address: order.customerAddress || '',
                            orderCount: 0,
                            totalSpent: 0
                        });
                    }
                    const c = customersMap.get(key);
                    c.orderCount += 1;
                    c.totalSpent += (order.totalAmount || 0);
                    if (order.customerAddress) c.address = order.customerAddress;
                });
                const headers = ['客户姓名','联系电话','客户地址','订单数','总消费'];
                const rows = Array.from(customersMap.values()).map(c => [
                    c.name,
                    c.phone,
                    c.address,
                    c.orderCount,
                    Number(c.totalSpent.toFixed(2))
                ]);
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
                XLSX.utils.book_append_sheet(wb, ws, '客户');
                const now = new Date();
                const fname = `customers_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.xlsx`;
                XLSX.writeFile(wb, fname);
            }
            
            // 新增订单按钮
            newOrderBtn.addEventListener('click', () => {
                newOrderModal.classList.remove('hidden');
                resetNewOrderForm();
                initProductSelects();
                initCustomerSelect();
            });
            
            // 新增商品按钮
            newProductBtn.addEventListener('click', () => {
                newProductModal.classList.remove('hidden');
                newProductForm.reset();
            });
            if (quickAddProductBtn) {
                quickAddProductBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    newProductModal.classList.remove('hidden');
                    newProductForm.reset();
                });
            }
            document.getElementById('undo-delete-btn').addEventListener('click', () => {
                const toast = document.getElementById('undo-toast');
                toast.classList.add('hidden');
                if (lastDeletedOrder) {
                    orders.unshift(lastDeletedOrder);
                    saveData();
                    renderOrders();
                    updateStatistics();
                    logOperation('restore_order', `订单:${lastDeletedOrder.id}`);
                    lastDeletedOrder = null;
                }
            });
            if (exportOrdersLink) {
                exportOrdersLink.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await exportOrdersToXLSX();
                    settingsDropdown.classList.add('hidden');
                });
            }
            if (exportCustomersLink) {
                exportCustomersLink.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await exportCustomersToXLSX();
                    settingsDropdown.classList.add('hidden');
                });
            }
            if (exportCombinedLink) {
                exportCombinedLink.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await exportCombinedToXLSX();
                    settingsDropdown.classList.add('hidden');
                });
            }
            const importCombinedInput = document.getElementById('import-combined-input');
            if (importCombinedLink && importCombinedInput) {
                importCombinedLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    importCombinedInput.value = '';
                    importCombinedInput.click();
                });
                importCombinedInput.addEventListener('change', async (e) => {
                    const file = e.target.files && e.target.files[0];
                    if (!file) return;
                    await importCombinedFromFile(file);
                    settingsDropdown.classList.add('hidden');
                });
            }
            closePaymentMethodModal.addEventListener('click', () => paymentMethodModal.classList.add('hidden'));
            confirmPaymentMethodBtn.addEventListener('click', () => {
                const id = paymentOrderIdInput.value;
                const method = paymentMethodSelect.value;
                const order = orders.find(o => o.id === id);
                if (!order) return;
                order.paymentMethod = method;
                order.settledAt = new Date().toISOString();
                order.status = 'completed';
                order.updatedAt = order.settledAt;
                saveData();
                paymentMethodModal.classList.add('hidden');
                renderOrders();
                updateStatistics();
                logOperation('settle_order', `订单:${id} 支付:${method}`);
                setTimeout(() => {
                    order.status = 'history';
                    order.updatedAt = new Date().toISOString();
                    saveData();
                    renderOrders();
                    updateStatistics();
                }, 3000);
            });
            closeReceiptModal.addEventListener('click', () => receiptModal.classList.add('hidden'));
            
            // 关闭模态框
            closeModal.addEventListener('click', () => newOrderModal.classList.add('hidden'));
            cancelOrder.addEventListener('click', () => newOrderModal.classList.add('hidden'));
            
            // 关闭商品模态框
            closeProductModal.addEventListener('click', () => newProductModal.classList.add('hidden'));
            cancelProduct.addEventListener('click', () => newProductModal.classList.add('hidden'));
            
            // 新增订单表单提交
            newOrderForm.addEventListener('submit', handleNewOrder);

            useCustomTotalCheckbox.addEventListener('change', () => {
                customTotalInput.disabled = !useCustomTotalCheckbox.checked;
                if (!useCustomTotalCheckbox.checked) {
                    customTotalInput.value = '';
                }
                updateOrderTotal();
            });
            customTotalInput.addEventListener('input', updateOrderTotal);
            
            // 新增商品表单提交
            newProductForm.addEventListener('submit', handleNewProduct);
            

            
            // 关闭编辑订单模态框
            closeEditOrderModal.addEventListener('click', () => editOrderModal.classList.add('hidden'));
            cancelEditOrder.addEventListener('click', () => editOrderModal.classList.add('hidden'));
            
            // 编辑订单表单提交
            editOrderForm.addEventListener('submit', handleEditOrder);
            
            // 关闭编辑客户模态框
            closeEditCustomerModal.addEventListener('click', () => editCustomerModal.classList.add('hidden'));
            cancelEditCustomer.addEventListener('click', () => editCustomerModal.classList.add('hidden'));
            
            // 编辑客户表单提交
            editCustomerForm.addEventListener('submit', handleEditCustomer);
            // 编辑商品模态框
            closeEditProductModal.addEventListener('click', () => editProductModal.classList.add('hidden'));
            cancelEditProduct.addEventListener('click', () => editProductModal.classList.add('hidden'));
            editProductForm.addEventListener('submit', handleEditProduct);
            // 财务管理事件
            addAdjustmentBtn.addEventListener('click', handleAddAdjustment);
            viewTransactionsBtn.addEventListener('click', () => renderTransactions());
            clearFinanceBtn.addEventListener('click', handleClearFinance);
            // 操作者与日志事件
            operatorSelect.value = currentOperator;
            operatorSelect.addEventListener('change', () => {
                currentOperator = operatorSelect.value;
                saveData();
            });
            
            // 添加商品
            addItemBtn.addEventListener('click', addNewItemRow);
            
            // 搜索订单
            searchOrders.addEventListener('input', (e) => {
                currentSearch = e.target.value.toLowerCase();
                renderOrders();
            });
            
            // 筛选订单
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // 更新按钮样式
                    filterBtns.forEach(b => {
                        b.classList.remove('bg-primary', 'text-white');
                        b.classList.add('hover:bg-gray-100');
                    });
                    btn.classList.add('bg-primary', 'text-white');
                    btn.classList.remove('hover:bg-gray-100');
                    
                    // 更新筛选条件
                    currentFilter = btn.dataset.filter;
                    
                    // 调试信息
                    console.log('筛选条件已更新:', currentFilter);
                    
                    // 重新渲染订单列表
                    renderOrders();
                });
            });
            const customerNameInput = document.getElementById('customer-name');
            const customerPhoneInput = document.getElementById('customer-phone');
            const customerAddressInput = document.getElementById('customer-address');
            const customerSelect = document.getElementById('customer-select');
            function getCustomersList() {
                const map = new Map();
                orders.forEach(o => {
                    const key = o.customerPhone;
                    if (!key) return;
                    const prev = map.get(key);
                    if (!prev) {
                        map.set(key, o);
                    } else {
                        const prevTime = new Date(prev.updatedAt || prev.createdAt);
                        const curTime = new Date(o.updatedAt || o.createdAt);
                        if (curTime > prevTime) map.set(key, o);
                    }
                });
                return Array.from(map.values()).map(o => ({
                    name: o.customerName,
                    phone: o.customerPhone,
                    address: o.customerAddress || ''
                }));
            }
            function initCustomerSelect() {
                if (!customerSelect) return;
                const customers = getCustomersList();
                customerSelect.innerHTML = '<option value="">请选择现有客户</option><option value="_new">新增客户</option>';
                customers.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.phone;
                    opt.textContent = `${c.name}（${c.phone}）`;
                    customerSelect.appendChild(opt);
                });
                if (customers.length === 0) {
                    customerSelect.value = '_new';
                    applyCustomerSelection();
                } else {
                    customerSelect.value = '';
                    applyCustomerSelection();
                }
            }
            function applyCustomerSelection() {
                if (!customerSelect) return;
                const val = customerSelect.value;
                if (val && val !== '_new') {
                    const existing = findExistingCustomerByPhone(val);
                    if (existing) {
                        if (customerNameInput) { customerNameInput.value = existing.name || ''; customerNameInput.readOnly = true; }
                        if (customerPhoneInput) { customerPhoneInput.value = existing.phone || ''; customerPhoneInput.readOnly = true; }
                        if (customerAddressInput) { customerAddressInput.value = existing.address || ''; customerAddressInput.readOnly = true; }
                    }
                } else {
                    if (customerNameInput) { customerNameInput.readOnly = false; }
                    if (customerPhoneInput) { customerPhoneInput.readOnly = false; }
                    if (customerAddressInput) { customerAddressInput.readOnly = false; }
                    if (val === '_new') {
                        // 保留用户可能已输入的内容
                    } else {
                        if (customerNameInput) customerNameInput.value = '';
                        if (customerPhoneInput) customerPhoneInput.value = '';
                        if (customerAddressInput) customerAddressInput.value = '';
                    }
                }
            }
            if (customerSelect) customerSelect.addEventListener('change', applyCustomerSelection);
            function findExistingCustomerByPhone(phone) {
                const matched = orders.filter(o => o.customerPhone === phone);
                if (matched.length === 0) return null;
                matched.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
                const latest = matched[0];
                return {
                    name: latest.customerName,
                    phone: latest.customerPhone,
                    address: latest.customerAddress || ''
                };
            }
            function findUniqueCustomerByName(name) {
                const matched = orders.filter(o => o.customerName === name);
                if (matched.length === 0) return null;
                const uniquePhones = new Set(matched.map(o => o.customerPhone));
                if (uniquePhones.size !== 1) return null;
                matched.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
                const latest = matched[0];
                return {
                    name: latest.customerName,
                    phone: latest.customerPhone,
                    address: latest.customerAddress || ''
                };
            }
            function handleCustomerPhoneInput(e) {
                const phone = e.target.value.trim();
                if (!phone) return;
                const existing = findExistingCustomerByPhone(phone);
                if (existing) {
                    if (customerNameInput) customerNameInput.value = existing.name || '';
                    if (customerAddressInput) customerAddressInput.value = existing.address || '';
                }
            }
            function handleCustomerNameInput(e) {
                const name = e.target.value.trim();
                if (!name) return;
                if (customerPhoneInput && customerPhoneInput.value.trim()) return;
                const existing = findUniqueCustomerByName(name);
                if (existing) {
                    if (customerPhoneInput) customerPhoneInput.value = existing.phone || '';
                    if (customerAddressInput) customerAddressInput.value = existing.address || '';
                }
            }
            if (customerPhoneInput) customerPhoneInput.addEventListener('input', handleCustomerPhoneInput);
            if (customerNameInput) customerNameInput.addEventListener('input', handleCustomerNameInput);

            // 关闭订单详情模态框
            closeDetailModal.addEventListener('click', () => orderDetailModal.classList.add('hidden'));
            
            // 取消删除
            cancelDelete.addEventListener('click', () => deleteConfirmModal.classList.add('hidden'));
            
            // 确认删除
            confirmDelete.addEventListener('click', handleDeleteOrder);
            
            // 初始化新增订单表单
            resetNewOrderForm();
            
            // 初始化商品选择下拉框
            initProductSelects();
        });
        
        // 从本地存储加载数据
        function loadData() {
            const savedOrders = localStorage.getItem('orders');
            if (savedOrders) {
                orders = JSON.parse(savedOrders);
            }
            
            const savedProducts = localStorage.getItem('products');
            if (savedProducts) {
                products = JSON.parse(savedProducts);
            }
            const savedTransactions = localStorage.getItem('transactions');
            if (savedTransactions) {
                transactions = JSON.parse(savedTransactions);
            }
            const savedOperationLogs = localStorage.getItem('operationLogs');
            if (savedOperationLogs) {
                operationLogs = JSON.parse(savedOperationLogs);
            }
            const savedOperator = localStorage.getItem('currentOperator');
            if (savedOperator) {
                currentOperator = savedOperator;
            }
            const savedUsers = localStorage.getItem('users');
            if (savedUsers) {
                try { const arr = JSON.parse(savedUsers); if (Array.isArray(arr)) { arr.forEach(su=>{ const u = users.find(x=>x.username===su.username); if (u) { u.password = su.password; u.permissions = su.permissions || u.permissions; } else { users.push(su); } }); } } catch {}
            }
            const savedExtraCustomers = localStorage.getItem('extraCustomers');
            if (savedExtraCustomers) {
                try { const arr = JSON.parse(savedExtraCustomers); if (Array.isArray(arr)) { extraCustomers = arr; } } catch {}
            }
        }
        
        // 保存数据到本地存储
        function saveData() {
            localStorage.setItem('orders', JSON.stringify(orders));
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('operationLogs', JSON.stringify(operationLogs));
            localStorage.setItem('currentOperator', currentOperator);
            localStorage.setItem('extraCustomers', JSON.stringify(extraCustomers));
            saveUsers();
        }
        
        // 处理登录
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // 验证用户
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                const cfg = getRememberConfig();
                if (rememberMeCheckbox && rememberMeCheckbox.checked && cfg.enabled) {
                    setRememberMe(username, cfg.ttlMs);
                } else {
                    clearRememberMe();
                }
                showMainApp();
            } else {
                errorMessage.textContent = '用户名或密码错误，请重试';
                errorMessage.classList.remove('hidden');
            }
        }
        function ensureDeviceId() {
            let id = localStorage.getItem('deviceId');
            if (!id) {
                id = 'dev-' + Date.now() + '-' + Math.random().toString(36).slice(2);
                localStorage.setItem('deviceId', id);
            }
            return id;
        }
        function setRememberMe(username, ttlMs) {
            const token = {
                username,
                deviceId: localStorage.getItem('deviceId') || ensureDeviceId(),
                expiresAt: Date.now() + (ttlMs || 3600000)
            };
            localStorage.setItem('rememberMe', JSON.stringify(token));
        }
        function clearRememberMe() {
            localStorage.removeItem('rememberMe');
        }
        function attemptAutoLogin() {
            try {
                const raw = localStorage.getItem('rememberMe');
                if (!raw) return;
                const token = JSON.parse(raw);
                if (!token || !token.username || !token.expiresAt || !token.deviceId) return;
                const now = Date.now();
                const currentDevice = localStorage.getItem('deviceId') || ensureDeviceId();
                const cfg = getRememberConfig();
                if (cfg.enabled && token.expiresAt > now && token.deviceId === currentDevice) {
                    const user = users.find(u => u.username === token.username);
                    if (user) {
                        currentUser = user;
                        showMainApp();
                    }
                }
            } catch (e) { /* ignore */ }
        }
        function getSystemPasswordEnabled(){ return localStorage.getItem('systemPwdEnabled') === 'true'; }
        function setSystemPasswordEnabled(v){ localStorage.setItem('systemPwdEnabled', v ? 'true' : 'false'); }
        function getSystemPasswordHash(){ return localStorage.getItem('systemPwdHash') || ''; }
        async function hashPasscode(code){
            try { const enc = new TextEncoder().encode(code); const buf = await crypto.subtle.digest('SHA-256', enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); } catch { return btoa(code); }
        }
        async function setSystemPassword(code){ const h = await hashPasscode(code); localStorage.setItem('systemPwdHash', h); }
        async function verifySystemPassword(code){ const h = await hashPasscode(code); return h === getSystemPasswordHash(); }
        function openPasscodeModal({ title, requireConfirm, onSubmit, onCancel }){
            const overlay = document.createElement('div'); overlay.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            const box = document.createElement('div'); box.className='bg-white rounded-lg shadow-xl w-full max-w-sm mx-4 p-6';
            box.innerHTML = `
                <div class="text-center text-lg font-semibold mb-4">${title}</div>
                <div id="passcode-dots" class="flex justify-center space-x-2 mb-4">${new Array(6).fill(0).map(()=>'<div class="w-4 h-4 rounded-full border border-gray-400"></div>').join('')}</div>
                <div id="passcode-keypad" class="grid grid-cols-3 gap-3">
                    ${[1,2,3,4,5,6,7,8,9,'del',0,'cancel'].map(k=>`<button data-key="${k}" class="px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-md text-lg">${k==='del'?t('del'):k==='cancel'?t('cancel'):k}</button>`).join('')}
                </div>`;
            overlay.appendChild(box); document.body.appendChild(overlay);
            let stage = 'enter'; let first = '' ; let input = '';
            const dots = () => box.querySelectorAll('#passcode-dots div');
            const updateDots = (n)=>{ dots().forEach((d,i)=>{ d.style.backgroundColor = i < n ? '#111827' : 'transparent'; }); };
            const close = ()=>{ document.body.removeChild(overlay); if (onCancel) onCancel(); };
            box.querySelectorAll('#passcode-keypad button').forEach(btn=>{
                btn.addEventListener('click', async ()=>{
                    const key = btn.getAttribute('data-key');
                    if (key==='cancel'){ close(); return; }
                    if (key==='del'){ input = input.slice(0,-1); updateDots(input.length); return; }
                    if (input.length<6 && /\d/.test(key)) { input += key; updateDots(input.length); }
                    if (input.length===6){
                        if (requireConfirm){
                            if (stage==='enter'){ first = input; input=''; stage='confirm'; updateDots(0); box.querySelector('.text-center').textContent = t('confirmSystemPassword'); return; }
                            if (stage==='confirm'){ if (input===first){ if(onSubmit) await onSubmit(input); document.body.removeChild(overlay); } else { alert(t('passwordMismatch')); input=''; updateDots(0); } }
                        } else { if(onSubmit) await onSubmit(input); document.body.removeChild(overlay); }
                    }
                });
            });
        }
        function openForgotSystemPasswordFlow(){
            const overlay = document.createElement('div'); overlay.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            const box = document.createElement('div'); box.className='bg-white rounded-lg shadow-xl w-full max-w-sm mx-4 p-6';
            box.innerHTML = `
                <div class="text-lg font-semibold mb-3">${t('forgotSystemPassword')}</div>
                <input id="fsp-username" class="w-full px-3 py-2 border rounded-md mb-2" placeholder="${t('accountUsername')}">
                <input id="fsp-password" type="password" class="w-full px-3 py-2 border rounded-md mb-3" placeholder="${t('accountPassword')}">
                <div class="flex justify-end space-x-2"><button id="fsp-cancel" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-md">${t('cancel')}</button><button id="fsp-next" class="px-3 py-2 bg-primary text-white rounded-md">${t('next')}</button></div>`;
            overlay.appendChild(box); document.body.appendChild(overlay);
            const close = ()=>{ document.body.removeChild(overlay); };
            box.querySelector('#fsp-cancel').addEventListener('click', close);
            box.querySelector('#fsp-next').addEventListener('click', ()=>{
                const u = box.querySelector('#fsp-username').value.trim();
                const p = box.querySelector('#fsp-password').value;
                const user = users.find(x=>x.username===u && x.password===p);
                if (!user){ alert(t('accountAuthFailed')); return; }
                close();
                openPasscodeModal({ title: t('setNewSystemPassword'), requireConfirm: true, onSubmit: async(code)=>{ await setSystemPassword(code); setSystemPasswordEnabled(true); alert(t('passwordReset')); } });
            });
        }
        function handleChangeAccountPassword(){
            const u = document.getElementById('change-acc-username').value.trim();
            const oldp = document.getElementById('change-acc-oldpwd').value;
            const newp = document.getElementById('change-acc-newpwd').value;
            const newp2 = document.getElementById('change-acc-newpwd2').value;
            if (!u || !oldp || !newp || !newp2){ alert(t('fillAll')); return; }
            if (newp !== newp2){ alert(t('passwordMismatch')); return; }
            const user = users.find(x=>x.username===u);
            if (!user){ alert(t('userNotFound')); return; }
            if (user.password !== oldp){ alert(t('oldPasswordIncorrect')); return; }
            user.password = newp; saveUsers(); alert(t('passwordChanged')); }
        function saveUsers(){ localStorage.setItem('users', JSON.stringify(users)); }
        function getAppLanguage() {
            return localStorage.getItem('appLanguage') || 'zh-CN';
        }
        function setAppLanguage(lang) {
            localStorage.setItem('appLanguage', lang);
        }
        function applyLanguage() {
            const lang = getAppLanguage();
            const dict = translations[lang] || translations['zh-CN'];
            if (appTitleEl) appTitleEl.textContent = dict.appTitle;
            if (settingsButtonTextEl) settingsButtonTextEl.textContent = dict.settings;
            if (settingsModalTitleEl) settingsModalTitleEl.textContent = dict.systemSettings;
            if (welcomeLabelEl) welcomeLabelEl.textContent = dict.welcome;
            if (loginPageTitleEl) loginPageTitleEl.textContent = dict.appTitle;
            if (loginSubtitleEl) loginSubtitleEl.textContent = dict.loginSubtitle;
            if (labelUsernameEl) labelUsernameEl.textContent = dict.username;
            if (labelPasswordEl) labelPasswordEl.textContent = dict.password;
            if (loginSubmitBtn) loginSubmitBtn.textContent = dict.login;
            document.documentElement.lang = lang;
            applySettingsNavLabels(dict);
            const dd = {
                order: document.getElementById('order-management-link'),
                customer: document.getElementById('customer-management-link'),
                product: document.getElementById('product-management-link'),
                finance: document.getElementById('financial-management-link'),
                logs: document.getElementById('operator-logs-link'),
                exportOrders: document.getElementById('export-orders-link'),
                exportCustomers: document.getElementById('export-customers-link')
            };
            if (dd.order) dd.order.textContent = dict.ddOrderMgmt;
            if (dd.customer) dd.customer.textContent = dict.ddCustomerMgmt;
            if (dd.product) dd.product.textContent = dict.ddProductMgmt;
            if (dd.finance) dd.finance.textContent = dict.ddFinanceMgmt;
            if (dd.logs) dd.logs.textContent = dict.ddOperatorLogs;
            if (dd.exportOrders) dd.exportOrders.textContent = dict.ddExportOrders;
            if (dd.exportCustomers) dd.exportCustomers.textContent = dict.ddExportCustomers;
            if (window.currentSettingsSection && !settingsModal.classList.contains('hidden')) {
                renderSettingsSection(window.currentSettingsSection);
            }
        }
        function applySettingsNavLabels(dict) {
            if (!settingsNav) return;
            settingsNav.querySelectorAll('button.settings-nav-btn').forEach(btn => {
                const sec = btn.getAttribute('data-section');
                const key = {
                    general: 'navGeneral', operator:'navOperator', order:'navOrder', history:'navHistory', finance:'navFinance', product:'navProduct', customer:'navCustomer', logs:'navLogs', kpi:'navKPI'
                }[sec];
                if (key && dict[key]) btn.textContent = dict[key];
            });
            if (settingsLogout) settingsLogout.textContent = dict.navLogout;
        }
        const translations = {
            'zh-CN': {
                appTitle:'订单管理系统', settings:'设置', systemSettings:'系统设置', welcome:'欢迎，', loginSubtitle:'请登录以访问系统', username:'用户名', password:'密码', login:'登录',
                navGeneral:'一般设置', navOperator:'操作者', currentOperator:'当前操作者', operatorStats:'操作者统计', navOrder:'订单管理', navHistory:'历史订单', navFinance:'财务状况', navProduct:'商品管理', navCustomer:'顾客管理', navLogs:'操作日志', navKPI:'核心KPI仪表盘', navLogout:'登出系统',
                openProductMgmt:'打开商品管理', openCustomerMgmt:'打开顾客管理', openOrderMgmt:'打开订单管理', viewPending:'查看待处理', openFinanceMgmt:'打开财务管理',
                ddOrderMgmt:'订单管理', ddCustomerMgmt:'客户管理', ddProductMgmt:'商品管理', ddFinanceMgmt:'财务管理', ddOperatorLogs:'操作者与日志', ddExportOrders:'导出订单 XLSX', ddExportCustomers:'导出客户 XLSX',
                loginSecurity:'登录与安全', allowRemember:'允许记住我自动登录', validPeriod:'有效期', ttl1h:'1小时', ttl24h:'24小时', ttl7d:'7天', saveLoginSecurity:'保存登录与安全', passwordIncorrect:'系统密码错误', settingsSaved:'设置已保存', languageTheme:'语言与主题', language:'语言', themeMode:'主题模式', langZhCN:'中文（简体）', langZhTW:'中文（繁體）', langEn:'English', themeLight:'明亮模式', themeDark:'黑暗模式',
                enableSystemPassword:'启用系统密码', forgotSystemPassword:'忘记系统密码', setSystemPassword:'设置系统密码', confirmSystemPassword:'确认系统密码', enterSystemPassword:'输入系统密码', passwordMismatch:'两次密码不一致', passwordSet:'系统密码已设置', setNewSystemPassword:'设置新的系统密码', passwordReset:'系统密码已重置', accountUsername:'账户名称', accountPassword:'账户密码', next:'下一步', cancel:'取消', del:'删除', changeAccountPassword:'更改账户密码', oldPassword:'旧密码', newPassword:'新密码', confirmNewPassword:'确认新密码', saveChange:'保存更改', fillAll:'请填写完整', userNotFound:'找不到该账户', oldPasswordIncorrect:'旧密码不正确', passwordChanged:'账户密码已更新'
            },
            'zh-TW': {
                appTitle:'訂單管理系統', settings:'設定', systemSettings:'系統設定', welcome:'歡迎，', loginSubtitle:'請登入以存取系統', username:'使用者名稱', password:'密碼', login:'登入',
                navGeneral:'一般設定', navOperator:'操作者', currentOperator:'目前操作者', operatorStats:'操作者統計', navOrder:'訂單管理', navHistory:'歷史訂單', navFinance:'財務狀況', navProduct:'商品管理', navCustomer:'顧客管理', navLogs:'操作日誌', navKPI:'核心KPI儀表板', navLogout:'登出系統',
                openProductMgmt:'打開商品管理', openCustomerMgmt:'打開顧客管理', openOrderMgmt:'打開訂單管理', viewPending:'查看待處理', openFinanceMgmt:'打開財務管理',
                ddOrderMgmt:'訂單管理', ddCustomerMgmt:'顧客管理', ddProductMgmt:'商品管理', ddFinanceMgmt:'財務管理', ddOperatorLogs:'操作者與日誌', ddExportOrders:'導出訂單 XLSX', ddExportCustomers:'導出顧客 XLSX',
                loginSecurity:'登入與安全', allowRemember:'允許記住我自動登入', validPeriod:'有效期', ttl1h:'1小時', ttl24h:'24小時', ttl7d:'7天', saveLoginSecurity:'保存登入與安全', passwordIncorrect:'系統密碼錯誤', settingsSaved:'設定已保存', languageTheme:'語言與主題', language:'語言', themeMode:'主題模式', langZhCN:'中文（簡體）', langZhTW:'中文（繁體）', langEn:'English', themeLight:'明亮模式', themeDark:'黑暗模式',
                enableSystemPassword:'啟用系統密碼', forgotSystemPassword:'忘記系統密碼', setSystemPassword:'設定系統密碼', confirmSystemPassword:'確認系統密碼', enterSystemPassword:'輸入系統密碼', passwordMismatch:'兩次密碼不一致', passwordSet:'系統密碼已設定', setNewSystemPassword:'設定新的系統密碼', passwordReset:'系統密碼已重置', accountUsername:'帳戶名稱', accountPassword:'帳戶密碼', next:'下一步', cancel:'取消', del:'刪除', changeAccountPassword:'更改帳戶密碼', oldPassword:'舊密碼', newPassword:'新密碼', confirmNewPassword:'確認新密碼', saveChange:'保存更改', fillAll:'請填寫完整', userNotFound:'找不到該帳戶', oldPasswordIncorrect:'舊密碼不正確', passwordChanged:'帳戶密碼已更新'
            },
            'en': {
                appTitle:'Order Management System', settings:'Settings', systemSettings:'System Settings', welcome:'Welcome, ', loginSubtitle:'Please log in to access the system', username:'Username', password:'Password', login:'Log In',
                navGeneral:'General', navOperator:'Operator', currentOperator:'Current Operator', operatorStats:'Operator Stats', navOrder:'Orders', navHistory:'Order History', navFinance:'Finance', navProduct:'Products', navCustomer:'Customers', navLogs:'Logs', navKPI:'Core KPI Dashboard', navLogout:'Log Out',
                openProductMgmt:'Open Product Management', openCustomerMgmt:'Open Customer Management', openOrderMgmt:'Open Order Management', viewPending:'View Pending', openFinanceMgmt:'Open Finance Management',
                ddOrderMgmt:'Order Management', ddCustomerMgmt:'Customer Management', ddProductMgmt:'Product Management', ddFinanceMgmt:'Financial Management', ddOperatorLogs:'Operator & Logs', ddExportOrders:'Export Orders XLSX', ddExportCustomers:'Export Customers XLSX',
                loginSecurity:'Login & Security', allowRemember:'Enable Remember Me Auto-Login', validPeriod:'Validity Period', ttl1h:'1 hour', ttl24h:'24 hours', ttl7d:'7 days', saveLoginSecurity:'Save Login & Security', passwordIncorrect:'Incorrect system password', settingsSaved:'Settings saved', languageTheme:'Language & Theme', language:'Language', themeMode:'Theme Mode', langZhCN:'Chinese (Simplified)', langZhTW:'Chinese (Traditional)', langEn:'English', themeLight:'Light Mode', themeDark:'Dark Mode',
                enableSystemPassword:'Enable System Password', forgotSystemPassword:'Forgot System Password', setSystemPassword:'Set System Password', confirmSystemPassword:'Confirm System Password', enterSystemPassword:'Enter System Password', passwordMismatch:'Passwords do not match', passwordSet:'System password set', setNewSystemPassword:'Set new system password', passwordReset:'System password reset', accountUsername:'Account Username', accountPassword:'Account Password', next:'Next', cancel:'Cancel', del:'Del', changeAccountPassword:'Change Account Password', oldPassword:'Old Password', newPassword:'New Password', confirmNewPassword:'Confirm New Password', saveChange:'Save Change', fillAll:'Please fill all fields', userNotFound:'User not found', oldPasswordIncorrect:'Old password incorrect', passwordChanged:'Account password updated'
            }
        };
        function t(key){ const lang=getAppLanguage(); const d=translations[lang]||translations['zh-CN']; return d[key]||key; }
        function getAppTheme() { return localStorage.getItem('appTheme') || 'light'; }
        function setAppTheme(theme) { localStorage.setItem('appTheme', theme); }
        function applyTheme() { const theme = getAppTheme(); if (theme==='dark') document.body.classList.add('dark'); else document.body.classList.remove('dark'); }
        function getRememberConfig() {
            try {
                const raw = localStorage.getItem('rememberConfig');
                const cfg = raw ? JSON.parse(raw) : {};
                return { enabled: cfg.enabled !== false, ttlMs: Number(cfg.ttlMs || 3600000) };
            } catch { return { enabled: true, ttlMs: 3600000 }; }
        }
        function setRememberConfig(cfg) {
            localStorage.setItem('rememberConfig', JSON.stringify({ enabled: !!cfg.enabled, ttlMs: Number(cfg.ttlMs || 3600000) }));
        }
        
        // 显示主应用
        function showMainApp() {
            loginPage.classList.add('hidden');
            mainApp.classList.remove('hidden');
            
            // 显示当前用户
            currentUserEl.textContent = currentUser.username;
            mobileUsernameEl.textContent = currentUser.username;
            
            // 渲染订单列表
            renderOrders();
            
            // 更新统计信息
            updateStatistics();
        }
        function showProductManagement() {
            productManagementModal.classList.remove('hidden');
            renderProductsManagement(document.getElementById('search-products').value.toLowerCase());
        }
        function showFinancialManagement() {
            financialManagementModal.classList.remove('hidden');
            renderTransactions();
        }
        function showOperatorLogs() {
            operatorLogsModal.classList.remove('hidden');
            operatorSelect.value = currentOperator;
            renderOperationLogs();
        }
        function showSettingsModal(section) {
            settingsModal.classList.remove('hidden');
            renderSettingsSection(section || 'operator');
            const active = section || 'operator';
            window.currentSettingsSection = active;
            settingsNav.querySelectorAll('.settings-nav-btn').forEach(b => {
                const isActive = b.getAttribute('data-section') === active;
                b.className = `settings-nav-btn w-full text-left px-3 py-2 rounded-md ${isActive ? 'bg-white border border-primary' : 'border border-transparent hover:bg-white'}`;
            });
        }
        function renderSettingsSection(section) {
            if (section === 'operator') {
                renderSettingsOperator();
            } else if (section === 'finance') {
                renderSettingsFinance();
            } else if (section === 'logs') {
                renderSettingsLogs();
            } else if (section === 'product') {
                renderSettingsProduct();
            } else if (section === 'customer') {
                renderSettingsCustomer();
            } else if (section === 'order') {
                renderSettingsOrder();
            } else if (section === 'history') {
                renderSettingsHistory();
            } else if (section === 'kpi') {
                renderSettingsKPI();
            } else if (section === 'general') {
                renderSettingsGeneral();
            } else {
                settingsContent.innerHTML = '';
            }
        }
        function renderSettingsOperator() {
            const operators = ['CTPP-01','CTPP-02','CTPP-03'];
            const stats = operators.map(op => {
                const handled = orders.filter(o => o.createdBy === op).length;
                const logsCount = operationLogs.filter(l => l.operator === op).length;
                return { op, handled, logsCount };
            });
            const current = currentOperator;
            const options = operators.map(op => `<option value="${op}">${op}</option>`).join('');
            const cards = stats.map(s => `
                <div class="flex justify-between items-center bg-gray-50 rounded-md p-4">
                    <div>
                        <div class="font-medium">${s.op}</div>
                        <div class="text-sm text-gray-600">处理订单：<span class="text-blue-600">${s.handled}</span></div>
                    </div>
                    <div class="text-sm text-gray-600">操作记录：<span class="text-green-600">${s.logsCount}</span>${s.op===current?' <span class="ml-2 text-gray-500">(当前)</span>':''}</div>
                </div>`).join('');
            settingsContent.innerHTML = `
                <h4 class="text-lg font-semibold">${t('navOperator')}</h4>
                <div>
                    <p class="text-sm text-gray-700 mb-1">${t('currentOperator')}</p>
                    <select id="settings-operator-select" class="w-full md:w-64 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">${options}</select>
                </div>
                <div class="space-y-3 mt-4">
                    <p class="text-sm font-medium text-gray-700">${t('operatorStats')}</p>
                    ${cards}
                </div>`;
            const sel = document.getElementById('settings-operator-select');
            sel.value = currentOperator;
            sel.addEventListener('change', () => { currentOperator = sel.value; operatorSelect.value = currentOperator; saveData(); renderSettingsOperator(); });
        }
        function renderSettingsFinance() {
            settingsContent.innerHTML = `
                <h4 class="text-lg font-semibold">${t('navFinance')}</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">调整金额（收入填正数，支出填负数）</label>
                        <input type="number" id="settings-adjust-amount" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">输入原因</label>
                        <input type="text" id="settings-adjust-reason" placeholder="例如：促销补贴、退款等" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-2">
                    <button id="settings-add-adjustment" class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-md transition-all">保存调整</button>
                    <button id="settings-open-finance" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-md transition-all">${t('openFinanceMgmt')}</button>
                </div>
                <div class="pt-4 border-t border-gray-200">
                    <p class="text-sm font-medium text-gray-700 mb-2">最近交易记录</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"><tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500">时间</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500">操作者</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500">类型</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500">金额</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500">原因</th>
                            </tr></thead>
                            <tbody id="settings-transactions-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>`;
            document.getElementById('settings-open-finance').addEventListener('click', () => showFinancialManagement());
            document.getElementById('settings-add-adjustment').addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('settings-adjust-amount').value);
                const reason = document.getElementById('settings-adjust-reason').value.trim();
                if (isNaN(amount) || amount === 0) { alert('请输入有效的调整金额'); return; }
                const entry = { time: new Date().toISOString(), operator: currentOperator, type: amount >= 0 ? '收入调整' : '支出调整', amount, reason };
                transactions.push(entry); saveData(); renderSettingsFinance(); logOperation('adjust_revenue', `金额:${amount} 原因:${reason}`);
            });
            const body = document.getElementById('settings-transactions-body');
            const recent = transactions.slice().reverse().slice(0, 10);
            body.innerHTML = recent.map(t => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${formatDate(t.time)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.operator || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${Number(t.amount).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.reason || ''}</td>
                </tr>`).join('');
        }
        function renderSettingsLogs() {
            settingsContent.innerHTML = `
                <h4 class="text-lg font-semibold">${t('navLogs')}</h4>
                <div class="overflow-x-auto mt-2">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500">时间</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500">操作者</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500">操作</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500">详情</th>
                        </tr></thead>
                        <tbody id="settings-logs-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>`;
            const body = document.getElementById('settings-logs-body');
            const recent = operationLogs.slice().reverse().slice(0, 20);
            body.innerHTML = recent.map(l => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${formatDate(l.time)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${l.operator}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${l.action}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${l.details || ''}</td>
                </tr>`).join('');
        }
        function renderSettingsProduct() {
            const count = products.length;
            const avg = count ? (products.reduce((s,p)=>s+(p.price||0),0)/count).toFixed(2) : '0.00';
            const categories = {};
            products.forEach(p=>{ const c=p.category||'未分类'; categories[c]=(categories[c]||0)+1; });
            const catHtml = Object.keys(categories).slice(0,5).map(c=>`<div class="flex justify-between"><span>${c}</span><span class="text-gray-600">${categories[c]}</span></div>`).join('') || '<p class="text-gray-500">暂无分类数据</p>';
            settingsContent.innerHTML = `
                <div class="flex justify-between items-center"><h4 class="text-lg font-semibold">${t('navProduct')}</h4><button id="settings-open-product" class="px-3 py-2 bg-primary text-white rounded-md">${t('openProductMgmt')}</button></div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">商品数量</div><div class="text-2xl font-semibold">${count}</div></div>
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">平均价格</div><div class="text-2xl font-semibold">¥${avg}</div></div>
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">分类概览</div><div class="mt-2 space-y-1">${catHtml}</div></div>
                </div>
                <div class="mt-4">
                    <p class="text-sm font-medium text-gray-700 mb-2">快速新增商品</p>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
                        <input id="settings-product-name" class="px-3 py-2 border rounded-md" placeholder="名称">
                        <input id="settings-product-category" class="px-3 py-2 border rounded-md" placeholder="分类">
                        <input id="settings-product-price" type="number" step="0.01" class="px-3 py-2 border rounded-md" placeholder="价格">
                        <input id="settings-product-desc" class="px-3 py-2 border rounded-md" placeholder="描述">
                    </div>
                    <div class="text-right mt-2"><button id="settings-add-product" class="px-4 py-2 bg-primary text-white rounded-md">添加</button></div>
                </div>
                <div class="mt-4">
                    <p class="text-sm font-medium text-gray-700 mb-2">商品一览</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500">名称</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500">分类</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500">价格</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500">描述</th>
                        </tr></thead><tbody id="settings-products-body" class="bg-white divide-y divide-gray-200"></tbody></table>
                    </div>
                </div>`;
            document.getElementById('settings-open-product').addEventListener('click', ()=>showProductManagement());
            document.getElementById('settings-add-product').addEventListener('click', ()=>{
                const name = document.getElementById('settings-product-name').value.trim();
                const category = document.getElementById('settings-product-category').value.trim();
                const price = parseFloat(document.getElementById('settings-product-price').value);
                const description = document.getElementById('settings-product-desc').value.trim();
                if (!name || !category || isNaN(price) || price<0) { alert('请填写有效的商品信息'); return; }
                if (products.find(p=>p.name===name)) { alert('该商品名称已存在'); return; }
                products.push({ name, category, price, description }); saveData(); initProductSelects(); logOperation('add_product', `商品:${name}`); renderSettingsProduct();
            });
            const body = document.getElementById('settings-products-body');
            const rows = products.slice(0,10).map(p=>`<tr><td class="px-6 py-4 text-sm">${p.name}</td><td class="px-6 py-4 text-sm text-gray-500">${p.category||''}</td><td class="px-6 py-4 text-sm">¥${Number(p.price||0).toFixed(2)}</td><td class="px-6 py-4 text-sm text-gray-500">${p.description||''}</td></tr>`).join('');
            body.innerHTML = rows || '<tr><td class="px-6 py-4 text-sm text-gray-500" colspan="4">暂无商品</td></tr>';
        }
        function renderSettingsCustomer() {
            const map = new Map();
            orders.forEach(o=>{ if(!map.has(o.customerPhone)){ map.set(o.customerPhone,{ name:o.customerName, phone:o.customerPhone, address:o.customerAddress||'', orderCount:0, totalSpent:0 }); } const c=map.get(o.customerPhone); c.orderCount++; c.totalSpent+=Number(o.totalAmount||0); });
            const customers = Array.from(map.values());
            const total = customers.length;
            const top = customers.slice().sort((a,b)=>b.totalSpent-a.totalSpent).slice(0,5);
            settingsContent.innerHTML = `
                <div class="flex justify-between items-center"><h4 class="text-lg font-semibold">${t('navCustomer')}</h4><button id="settings-open-customer" class="px-3 py-2 bg-primary text-white rounded-md">${t('openCustomerMgmt')}</button></div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">客户数量</div><div class="text-2xl font-semibold">${total}</div></div>
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">总订单数</div><div class="text-2xl font-semibold">${orders.length}</div></div>
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">总销售额</div><div class="text-2xl font-semibold">¥${Number(orders.reduce((s,o)=>s+Number(o.totalAmount||0),0)).toFixed(2)}</div></div>
                </div>
                <div class="mt-4">
                    <p class="text-sm font-medium text-gray-700 mb-2">高价值客户</p>
                    <div class="space-y-2">${top.map(c=>`<div class="flex justify-between bg-gray-50 rounded-md p-3"><span>${c.name} (${c.phone})</span><span class="text-blue-600">¥${c.totalSpent.toFixed(2)}</span></div>`).join('') || '<p class="text-gray-500">暂无数据</p>'}</div>
                </div>`;
            document.getElementById('settings-open-customer').addEventListener('click', ()=>showCustomerManagement());
        }
        function renderSettingsOrder() {
            const statusCounts = { pending:0, completed:0, cancelled:0, soldOut:0, history:0 };
            orders.forEach(o=>{ statusCounts[o.status]=(statusCounts[o.status]||0)+1; });
            const today = new Date(); today.setHours(0,0,0,0);
            const todayRevenue = orders.filter(o=>{ const d=new Date(o.createdAt); d.setHours(0,0,0,0); return d.getTime()===today.getTime() && o.status!=='cancelled'; }).reduce((s,o)=>s+Number(o.totalAmount||0),0);
            const productTotals = {};
            orders.forEach(o=>{ (o.items||[]).forEach(i=>{ productTotals[i.name]=(productTotals[i.name]||0)+Number(i.quantity||0); }); });
            const topProducts = Object.entries(productTotals).sort((a,b)=>b[1]-a[1]).slice(0,5);
            settingsContent.innerHTML = `
                <div class="flex justify-between items-center"><h4 class="text-lg font-semibold">${t('navOrder')}</h4><div class="space-x-2"><button id="settings-open-order" class="px-3 py-2 bg-primary text-white rounded-md">${t('openOrderMgmt')}</button><button id="settings-view-pending" class="px-3 py-2 bg-yellow-500 text-white rounded-md">${t('viewPending')}</button></div></div>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-3">
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">待处理</div><div class="text-2xl font-semibold">${statusCounts.pending||0}</div></div>
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">已完成</div><div class="text-2xl font-semibold">${statusCounts.completed||0}</div></div>
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">已取消</div><div class="text-2xl font-semibold">${statusCounts.cancelled||0}</div></div>
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">缺货</div><div class="text-2xl font-semibold">${statusCounts.soldOut||0}</div></div>
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">历史订单</div><div class="text-2xl font-semibold">${statusCounts.history||0}</div></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">今日销售额</div><div class="text-2xl font-semibold">¥${Number(todayRevenue).toFixed(2)}</div></div>
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">热门商品</div><div class="mt-2 space-y-1">${topProducts.map(([n,q])=>`<div class="flex justify-between"><span>${n}</span><span class="text-gray-600">${q}</span></div>`).join('') || '<p class="text-gray-500">暂无数据</p>'}</div></div>
                </div>`;
            document.getElementById('settings-open-order').addEventListener('click', ()=>{ settingsModal.classList.add('hidden'); showOrderManagement(); });
            document.getElementById('settings-view-pending').addEventListener('click', ()=>{ currentFilter='pending'; renderOrders(); settingsModal.classList.add('hidden'); });
        }
        function renderSettingsHistory() {
            const list = orders.filter(o=>o.status==='history').slice().reverse().slice(0,10);
            settingsContent.innerHTML = `
                <div class="flex justify-between items-center"><h4 class="text-lg font-semibold">${t('navHistory')}</h4><button id="settings-open-order-history" class="px-3 py-2 bg-primary text-white rounded-md">${t('openOrderMgmt')}</button></div>
                <div class="overflow-x-auto mt-3"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500">订单编号</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500">客户</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500">金额</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500">结算时间</th>
                </tr></thead><tbody id="settings-history-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>`;
            document.getElementById('settings-open-order-history').addEventListener('click', ()=>{ currentFilter='history'; renderOrders(); settingsModal.classList.add('hidden'); });
            const body = document.getElementById('settings-history-body');
            body.innerHTML = list.map(o=>`<tr><td class="px-6 py-4 text-sm">${o.id}</td><td class="px-6 py-4 text-sm text-gray-500">${o.customerName}</td><td class="px-6 py-4 text-sm">¥${Number(o.totalAmount||0).toFixed(2)}</td><td class="px-6 py-4 text-sm text-gray-500">${o.settledAt?formatDate(o.settledAt):''}</td></tr>`).join('') || '<tr><td class="px-6 py-4 text-sm text-gray-500" colspan="4">暂无历史订单</td></tr>';
        }
        function renderSettingsGeneral() {
            const cfg = getRememberConfig();
            const lang = getAppLanguage();
            const theme = getAppTheme();
            settingsContent.innerHTML = `
                <h4 class="text-lg font-semibold">${t('navGeneral')}</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                    <div class="bg-gray-50 rounded-md p-4">
                        <div class="text-sm font-medium text-gray-700 mb-2">${t('loginSecurity')}</div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="settings-remember-enabled" class="h-4 w-4 text-primary border-gray-300 rounded" ${cfg.enabled ? 'checked' : ''}>
                            <label for="settings-remember-enabled" class="text-sm text-gray-700">${t('allowRemember')}</label>
                        </div>
                        <div class="mt-2">
                            <label class="block text-sm text-gray-700 mb-1">${t('validPeriod')}</label>
                            <select id="settings-remember-ttl" class="w-full md:w-64 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="3600000" ${cfg.ttlMs===3600000?'selected':''}>${t('ttl1h')}</option>
                                <option value="86400000" ${cfg.ttlMs===86400000?'selected':''}>${t('ttl24h')}</option>
                                <option value="604800000" ${cfg.ttlMs===604800000?'selected':''}>${t('ttl7d')}</option>
                            </select>
                        </div>
                        <div class="mt-3">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="settings-system-pwd-enabled" class="h-4 w-4 text-primary border-gray-300 rounded">
                                <label for="settings-system-pwd-enabled" class="text-sm text-gray-700">${t('enableSystemPassword')}</label>
                            </div>
                            <div class="mt-2 flex items-center space-x-2">
                                <button id="settings-general-save" class="px-4 py-2 bg-primary text-white rounded-md">${t('saveLoginSecurity')}</button>
                                <button id="settings-forgot-system-pwd" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-md">${t('forgotSystemPassword')}</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-md p-4">
                        <div class="text-sm font-medium text-gray-700 mb-2">${t('languageTheme')}</div>
                        <div>
                            <label class="block text-sm text-gray-700 mb-1">${t('language')}</label>
                            <select id="settings-language" class="w-full md:w-64 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="zh-CN" ${lang==='zh-CN'?'selected':''}>${t('langZhCN')}</option>
                                <option value="zh-TW" ${lang==='zh-TW'?'selected':''}>${t('langZhTW')}</option>
                                <option value="en" ${lang==='en'?'selected':''}>${t('langEn')}</option>
                            </select>
                        </div>
                        <div class="mt-2">
                            <label class="block text-sm text-gray-700 mb-1">${t('themeMode')}</label>
                            <select id="settings-theme" class="w-full md:w-64 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="light" ${theme==='light'?'selected':''}>${t('themeLight')}</option>
                                <option value="dark" ${theme==='dark'?'selected':''}>${t('themeDark')}</option>
                            </select>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm font-medium text-gray-700 mb-2">${t('changeAccountPassword')}</p>
                            <div class="space-y-2">
                                <input id="change-acc-username" class="w-full md:w-64 px-3 py-2 border rounded-md" placeholder="${t('accountUsername')}">
                                <input id="change-acc-oldpwd" type="password" class="w-full md:w-64 px-3 py-2 border rounded-md" placeholder="${t('oldPassword')}">
                                <input id="change-acc-newpwd" type="password" class="w-full md:w-64 px-3 py-2 border rounded-md" placeholder="${t('newPassword')}">
                                <input id="change-acc-newpwd2" type="password" class="w-full md:w-64 px-3 py-2 border rounded-md" placeholder="${t('confirmNewPassword')}">
                                <div><button id="change-acc-save" class="px-4 py-2 bg-primary text-white rounded-md">${t('saveChange')}</button></div>
                            </div>
                        </div>
                    </div>
                </div>`;
            const enabledChk = document.getElementById('settings-remember-enabled');
            const ttlSel = document.getElementById('settings-remember-ttl');
            const langSel = document.getElementById('settings-language');
            const themeSel = document.getElementById('settings-theme');
            langSel.addEventListener('change', () => { setAppLanguage(langSel.value); applyLanguage(); });
            themeSel.addEventListener('change', () => { setAppTheme(themeSel.value); applyTheme(); });
            const saveBtn = document.getElementById('settings-general-save');
            const sysPwdEnabledChk = document.getElementById('settings-system-pwd-enabled');
            sysPwdEnabledChk.checked = getSystemPasswordEnabled();
            sysPwdEnabledChk.addEventListener('change', () => {
                if (sysPwdEnabledChk.checked && !getSystemPasswordHash()) {
                    openPasscodeModal({ title: t('setSystemPassword'), requireConfirm: true, onSubmit: async (code) => { await setSystemPassword(code); setSystemPasswordEnabled(true); alert(t('passwordSet')); } , onCancel: () => { sysPwdEnabledChk.checked = false; } });
                } else {
                    setSystemPasswordEnabled(sysPwdEnabledChk.checked);
                }
            });
            saveBtn.addEventListener('click', () => {
                const c = getRememberConfig(); c.enabled = enabledChk.checked; c.ttlMs = Number(ttlSel.value); setRememberConfig(c);
                if (getSystemPasswordEnabled()) {
                    openPasscodeModal({ title: t('enterSystemPassword'), requireConfirm: false, onSubmit: async (code) => { const ok = await verifySystemPassword(code); if (!ok) { alert(t('passwordIncorrect')); return; } alert(t('settingsSaved')); }, onCancel: () => {} });
                } else { alert(t('settingsSaved')); }
            });
            const forgotBtn = document.getElementById('settings-forgot-system-pwd');
            forgotBtn.addEventListener('click', () => { openForgotSystemPasswordFlow(); });
            const caSave = document.getElementById('change-acc-save');
            caSave.addEventListener('click', () => { handleChangeAccountPassword(); });
        }
        function renderSettingsKPI() {
            const today = new Date(); today.setHours(0,0,0,0);
            const todayOrders = orders.filter(o=>{ const d=new Date(o.createdAt); d.setHours(0,0,0,0); return d.getTime()===today.getTime(); });
            const pendingCount = orders.filter(o=>o.status==='pending').length;
            const completedCount = orders.filter(o=>o.status==='completed').length;
            const historyCount = orders.filter(o=>o.status==='history').length;
            const todayRevenue = todayOrders.filter(o=>o.status!=='cancelled').reduce((s,o)=>s+Number(o.totalAmount||0),0);
            const productTotals = {}; (orders||[]).forEach(o=>{ (o.items||[]).forEach(i=>{ productTotals[i.name]=(productTotals[i.name]||0)+Number(i.quantity||0); }); });
            const topProducts = Object.entries(productTotals).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const recentNotes = (orders||[]).slice().reverse().map(o=>o.notes).filter(Boolean).slice(0,5);
            settingsContent.innerHTML = `
                <h4 class="text-lg font-semibold">${t('navKPI')}</h4>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-3">
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">今日销售额</div><div class="text-2xl font-semibold">¥${Number(todayRevenue).toFixed(2)}</div></div>
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">订单数</div><div class="text-2xl font-semibold">${todayOrders.length}</div></div>
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">热门商品</div><div class="mt-2 space-y-1">${topProducts.map(([n,q])=>`<div class="flex justify-between"><span>${n}</span><span class="text-gray-600">${q}</span></div>`).join('') || '<p class="text-gray-500">暂无数据</p>'}</div></div>
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">待处理订单</div><div class="text-2xl font-semibold">${pendingCount}</div></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">状态统计</div>
                        <div class="mt-2 space-y-1">
                            <div class="flex justify-between"><span>已完成</span><span class="text-gray-600">${completedCount}</span></div>
                            <div class="flex justify-between"><span>历史订单</span><span class="text-gray-600">${historyCount}</span></div>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-md p-4"><div class="text-sm text-gray-600">最近备注</div>
                        <div class="mt-2 space-y-1">${recentNotes.map(n=>`<div class="text-sm text-gray-600">• ${n}</div>`).join('') || '<p class="text-gray-500">暂无备注</p>'}</div>
                    </div>
                </div>`;
        }
        function renderProductsManagement(searchTerm) {
            productsList.innerHTML = '';
            let list = products || [];
            if (searchTerm) {
                list = list.filter(p => (p.name || '').toLowerCase().includes(searchTerm) || (p.category || '').toLowerCase().includes(searchTerm));
            }
            if (list.length === 0) {
                emptyProducts.classList.remove('hidden');
                return;
            } else {
                emptyProducts.classList.add('hidden');
            }
            list.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${p.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥${Number(p.price).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.description || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="edit-product-btn text-primary hover:text-blue-800 mr-3" data-name="${p.name}">编辑</button>
                        <button class="delete-product-btn text-red-600 hover:text-red-800" data-name="${p.name}">删除</button>
                    </td>
                `;
                productsList.appendChild(tr);
            });
            document.querySelectorAll('.edit-product-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const name = e.currentTarget.dataset.name;
                    openEditProductModal(name);
                });
            });
            document.querySelectorAll('.delete-product-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const name = e.currentTarget.dataset.name;
                    handleDeleteProduct(name);
                });
            });
        }
        function renderTransactions() {
            transactionsList.innerHTML = '';
            if (!transactions || transactions.length === 0) {
                emptyTransactions.classList.remove('hidden');
                return;
            }
            emptyTransactions.classList.add('hidden');
            transactions.slice().reverse().forEach(t => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(t.time)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.operator || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${Number(t.amount).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.reason || ''}</td>
                `;
                transactionsList.appendChild(tr);
            });
        }
        function handleAddAdjustment() {
            const amount = parseFloat(adjustAmountInput.value);
            const reason = adjustReasonInput.value.trim();
            if (isNaN(amount) || amount === 0) { alert('请输入有效的调整金额'); return; }
            const entry = { time: new Date().toISOString(), operator: currentOperator, type: amount >= 0 ? '收入调整' : '支出调整', amount, reason };
            transactions.push(entry);
            saveData();
            renderTransactions();
            logOperation('adjust_revenue', `金额:${amount} 原因:${reason}`);
            adjustAmountInput.value = '';
            adjustReasonInput.value = '';
        }
        function handleClearFinance() {
            const v = (clearFinanceConfirmInput.value || '').toLowerCase();
            if (!(v === '清除' || v === 'reset')) { alert('请输入 清除 或 reset'); return; }
            transactions = [];
            saveData();
            renderTransactions();
            logOperation('clear_finance', '清除全部总支出与总收入');
            clearFinanceConfirmInput.value = '';
        }
        function renderOperationLogs() {
            operationLogsList.innerHTML = '';
            if (!operationLogs || operationLogs.length === 0) {
                emptyOperationLogs.classList.remove('hidden');
                return;
            }
            emptyOperationLogs.classList.add('hidden');
            operationLogs.slice().reverse().forEach(l => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(l.time)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${l.operator}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${l.action}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${l.details || ''}</td>
                `;
                operationLogsList.appendChild(tr);
            });
        }
        function logOperation(action, details) {
            const entry = { time: new Date().toISOString(), operator: currentOperator, action, details };
            operationLogs.push(entry);
            saveData();
        }
        function openEditProductModal(name) {
            const p = products.find(x => x.name === name);
            if (!p) return;
            editProductOriginalName.value = p.name;
            editProductName.value = p.name;
            editProductCategory.value = p.category || '';
            editProductPrice.value = p.price || 0;
            editProductDescription.value = p.description || '';
            editProductModal.classList.remove('hidden');
        }
        function handleEditProduct(e) {
            e.preventDefault();
            const originalName = editProductOriginalName.value;
            const name = editProductName.value.trim();
            const category = editProductCategory.value.trim();
            const price = parseFloat(editProductPrice.value);
            const description = editProductDescription.value.trim();
            if (!name || !category || isNaN(price) || price < 0) {
                alert('请填写有效的商品信息');
                return;
            }
            const other = products.find(p => p.name === name && p.name !== originalName);
            if (other) {
                alert('该商品名称已存在');
                return;
            }
            const idx = products.findIndex(p => p.name === originalName);
            if (idx >= 0) {
                products[idx] = { name, category, price, description };
            }
            saveData();
            initProductSelects();
            renderProductsManagement(document.getElementById('search-products').value.toLowerCase());
            editProductModal.classList.add('hidden');
            alert('商品已更新');
            logOperation('update_product', `商品:${name}`);
        }
        function handleDeleteProduct(name) {
            if (!confirm(`确定删除商品「${name}」吗？`)) return;
            products = products.filter(p => p.name !== name);
            saveData();
            initProductSelects();
            renderProductsManagement(document.getElementById('search-products').value.toLowerCase());
            alert('商品已删除');
            logOperation('delete_product', `商品:${name}`);
        }
        
        // 处理退出登录
        function handleLogout() {
            currentUser = null;
            mainApp.classList.add('hidden');
            loginPage.classList.remove('hidden');
            loginForm.reset();
            errorMessage.classList.add('hidden');
            clearRememberMe();
        }
        
        // 重置新增订单表单
        function resetNewOrderForm() {
            newOrderForm.reset();
            
            // 清空商品列表，保留一行
            itemsContainer.innerHTML = '';
            addNewItemRow();
            
            // 重置总价
            updateOrderTotal();

            useCustomTotalCheckbox.checked = false;
            customTotalInput.value = '';
            customTotalInput.disabled = true;
            if (typeof customerSelect !== 'undefined' && customerSelect) {
                customerSelect.value = '';
            }
            if (customerNameInput) customerNameInput.readOnly = false;
            if (customerPhoneInput) customerPhoneInput.readOnly = false;
            if (customerAddressInput) customerAddressInput.readOnly = false;
        }
        
        // 添加新的商品行
        function addNewItemRow() {
            const itemRow = document.createElement('div');
            itemRow.className = 'item-row grid grid-cols-10 gap-2';
            
            // 动态生成商品选项
            let options = '<option value="">选择商品</option>';
            products.forEach(product => {
                options += `<option value="${product.name}">${product.name} - ¥${product.price}</option>`;
            });
            
            itemRow.innerHTML = `
                <select class="item-select col-span-5 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    ${options}
                </select>
                <input type="number" class="item-quantity col-span-2 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" min="1" value="1">
                <span class="item-price col-span-2 px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-700" readonly>¥0</span>
                <button type="button" class="remove-item col-span-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition-all">
                    <i class="fa fa-trash"></i>
                </button>
            `;
            
            itemsContainer.appendChild(itemRow);
            
            // 添加事件监听器
            const select = itemRow.querySelector('.item-select');
            const quantity = itemRow.querySelector('.item-quantity');
            const removeBtn = itemRow.querySelector('.remove-item');
            
            select.addEventListener('change', updateOrderTotal);
            quantity.addEventListener('input', updateOrderTotal);
            
            removeBtn.addEventListener('click', () => {
                // 确保至少有一行
                if (itemsContainer.children.length > 1) {
                    itemRow.remove();
                    updateOrderTotal();
                } else {
                    alert('至少需要一项商品');
                }
            });
        }
        
        // 初始化商品选择下拉框
        function initProductSelects() {
            // 更新所有商品选择下拉框
            document.querySelectorAll('.item-select').forEach(select => {
                // 保存当前选中的值
                const selectedValue = select.value;
                
                // 清空选项
                select.innerHTML = '<option value="">选择商品</option>';
                
                // 添加商品选项
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.name;
                    option.textContent = `${product.name} - ¥${product.price}`;
                    
                    // 恢复选中状态
                    if (selectedValue === product.name) {
                        option.selected = true;
                    }
                    
                    select.appendChild(option);
                });
            });
        }
        
        // 处理新增商品
        function handleNewProduct(e) {
            e.preventDefault();
            
            const productName = document.getElementById('product-name').value;
            const productPrice = parseFloat(document.getElementById('product-price').value);
            const productCategory = document.getElementById('product-category').value;
            const productDescription = document.getElementById('product-description').value;
            
            // 验证输入
            if (!productName || !productPrice || !productCategory) {
                alert('请填写完整的商品信息');
                return;
            }
            
            if (isNaN(productPrice) || productPrice <= 0) {
                alert('请输入有效的商品价格');
                return;
            }
            
            // 检查商品是否已存在
            const existingProduct = products.find(p => p.name === productName);
            if (existingProduct) {
                alert('该商品名称已存在');
                return;
            }
            
            // 创建新商品
            const newProduct = {
                name: productName,
                category: productCategory,
                price: productPrice,
                description: productDescription
            };
            
            // 添加到商品列表
            products.push(newProduct);
            
            // 保存数据
            saveData();
            
            // 重新初始化商品选择下拉框
            initProductSelects();
            
            // 关闭模态框
            newProductModal.classList.add('hidden');
            
            // 重置表单
            newProductForm.reset();
            
            // 显示成功消息
            alert('商品添加成功');
            if (productManagementModal && !productManagementModal.classList.contains('hidden')) {
                const term = (document.getElementById('search-products').value || '').toLowerCase();
                renderProductsManagement(term);
            }
            logOperation('add_product', `商品:${productName}`);
        }
        
        // 更新订单总价
        function updateOrderTotal() {
            let total = 0;
            
            document.querySelectorAll('.item-row').forEach(row => {
                const select = row.querySelector('.item-select');
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                
                if (select.value) {
                    const product = products.find(p => p.name === select.value);
                    if (product) {
                        const itemTotal = product.price * quantity;
                        row.querySelector('.item-price').textContent = `¥${itemTotal}`;
                        total += itemTotal;
                    }
                }
            });
            const useCustom = useCustomTotalCheckbox && useCustomTotalCheckbox.checked;
            const customVal = parseFloat(customTotalInput && customTotalInput.value);
            if (useCustom && !isNaN(customVal)) {
                orderTotalEl.textContent = `¥${customVal.toFixed(2)}`;
            } else {
                orderTotalEl.textContent = `¥${total.toFixed(2)}`;
            }
        }
        
        // 处理新增订单
        function handleNewOrder(e) {
            e.preventDefault();
            
            const customerMode = (typeof customerSelect !== 'undefined' && customerSelect) ? customerSelect.value : '_new';
            if (customerMode === '') {
                alert('请选择现有客户，或选择“新增客户”');
                return;
            }
            const customerName = document.getElementById('customer-name').value;
            const customerPhone = document.getElementById('customer-phone').value;
            const customerAddress = document.getElementById('customer-address').value;
            const notes = document.getElementById('order-notes').value;
            if (customerMode === '_new') {
                if (!customerName || !customerPhone) {
                    alert('请填写客户姓名和联系电话');
                    return;
                }
            }
            
            // 收集商品信息
            const items = [];
            let totalAmount = 0;
            let isValid = true;
            
            document.querySelectorAll('.item-row').forEach(row => {
                const select = row.querySelector('.item-select');
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                
                if (!select.value) {
                    isValid = false;
                    return;
                }
                
                const product = products.find(p => p.name === select.value);
                if (product && quantity > 0) {
                    items.push({
                        name: product.name,
                        quantity: quantity,
                        price: product.price
                    });
                    
                    totalAmount += product.price * quantity;
                } else {
                    isValid = false;
                }
            });
            
            if (!isValid || items.length === 0) {
                alert('请填写完整的订单信息');
                return;
            }

            if (useCustomTotalCheckbox.checked) {
                const customVal = parseFloat(customTotalInput.value);
                if (isNaN(customVal) || customVal < 0) {
                    alert('请输入有效的自定义总价');
                    return;
                }
                totalAmount = customVal;
            }
            
            // 创建新订单
            const newOrder = {
                id: "ORD" + Date.now().toString().slice(-6),
                customerName: customerName,
                customerPhone: customerPhone,
                customerAddress: customerAddress,
                items: items,
                status: "pending",
                notes: notes,
                totalAmount: totalAmount,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                createdBy: currentOperator
            };
            
            // 添加到订单列表
            orders.unshift(newOrder);
            
            // 保存数据
            saveData();
            
            // 重新渲染订单列表
            renderOrders();
            
            // 更新统计信息
            updateStatistics();
            
            // 关闭模态框
            newOrderModal.classList.add('hidden');
            
            // 显示成功消息
            alert('订单创建成功');
            logOperation('create_order', `订单:${newOrder.id} 金额:${newOrder.totalAmount}`);
        }
        
        // 渲染订单列表
        function renderOrders() {
            // 筛选和搜索订单
            let filteredOrders = orders;
            
            // 调试信息
            console.log('开始渲染订单列表，当前筛选条件:', currentFilter);
            console.log('筛选前订单总数:', orders.length);
            
            // 应用筛选
            if (currentFilter !== 'all') {
                if (currentFilter === 'history') {
                    // 历史订单筛选只显示历史订单
                    filteredOrders = filteredOrders.filter(order => order.status === 'history');
                } else {
                    // 其他筛选不显示历史订单
                    filteredOrders = filteredOrders.filter(order => 
                        order.status === currentFilter && order.status !== 'history'
                    );
                }
                console.log('筛选后订单数:', filteredOrders.length);
            } else {
                // 全部订单不显示历史订单
                filteredOrders = filteredOrders.filter(order => order.status !== 'history');
            }
            
            // 应用搜索
            if (currentSearch) {
                filteredOrders = filteredOrders.filter(order => 
                    order.id.toLowerCase().includes(currentSearch) ||
                    order.customerName.toLowerCase().includes(currentSearch) ||
                    order.customerPhone.includes(currentSearch)
                );
            }
            
            // 更新订单数量
            orderCountEl.textContent = filteredOrders.length;
            
            // 显示或隐藏空订单提示
            if (filteredOrders.length === 0) {
                ordersList.innerHTML = '';
                emptyOrders.classList.remove('hidden');
            } else {
                emptyOrders.classList.add('hidden');
                
                // 渲染订单列表
                ordersList.innerHTML = '';
                
                filteredOrders.forEach(order => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 cursor-pointer';
                    
                    // 格式化日期
                    const createdAt = new Date(order.createdAt);
                    const formattedDate = `${createdAt.getFullYear()}-${String(createdAt.getMonth() + 1).padStart(2, '0')}-${String(createdAt.getDate()).padStart(2, '0')} ${String(createdAt.getHours()).padStart(2, '0')}:${String(createdAt.getMinutes()).padStart(2, '0')}`;
                    
                    // 获取状态标签类
                    const statusClass = getStatusClass(order.status);
                    
                    // 获取状态标签文本
                    const statusText = getStatusText(order.status);
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${order.id}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${order.customerName}</div>
                            <div class="text-sm text-gray-500">${order.customerPhone}</div>
                        </td>
                        <td class="px-6 py-4 hidden sm:table-cell">
                            <div class="text-sm text-gray-900">
                                ${order.items.map(item => `${item.name} x${item.quantity}`).join('<br>')}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">¥${order.totalAmount.toFixed(2)}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">
                            ${formattedDate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium hidden sm:table-cell">
                            <button class="view-order text-primary hover:text-blue-800 mr-3" data-id="${order.id}">
                                查看
                            </button>
                        </td>
                    `;
                    
                    ordersList.appendChild(row);
                    
                    // 添加查看订单事件
                    row.querySelector('.view-order').addEventListener('click', (e) => {
                        e.stopPropagation();
                        viewOrderDetail(order.id);
                    });
                    
                    // 点击行查看订单详情
                    row.addEventListener('click', () => {
                        viewOrderDetail(order.id);
                    });
                });
            }
        }
        
        // 查看订单详情
        function viewOrderDetail(orderId) {
            const order = orders.find(o => o.id === orderId);
            
            if (!order) return;
            
            // 填充订单详情
            document.getElementById('detail-order-id').textContent = order.id;
            
            const createdAt = new Date(order.createdAt);
            const formattedDate = `${createdAt.getFullYear()}-${String(createdAt.getMonth() + 1).padStart(2, '0')}-${String(createdAt.getDate()).padStart(2, '0')} ${String(createdAt.getHours()).padStart(2, '0')}:${String(createdAt.getMinutes()).padStart(2, '0')}`;
            document.getElementById('detail-order-time').textContent = formattedDate;
            
            document.getElementById('detail-customer-name').textContent = order.customerName;
            document.getElementById('detail-customer-phone').textContent = order.customerPhone;
            document.getElementById('detail-customer-address').textContent = order.customerAddress || '无地址信息';
            
            document.getElementById('detail-order-notes').textContent = order.notes || '无';
            document.getElementById('detail-order-total').textContent = `¥${order.totalAmount.toFixed(2)}`;
            
            // 设置状态标签
            const statusEl = document.getElementById('detail-order-status');
            statusEl.className = `inline-block px-3 py-1 rounded-full text-sm font-medium ${getStatusClass(order.status)}`;
            statusEl.textContent = getStatusText(order.status);
            
            // 填充商品列表
            const itemsList = document.getElementById('detail-items-list');
            itemsList.innerHTML = '';
            
            order.items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between';
                itemEl.innerHTML = `
                    <span>${item.name} x${item.quantity}</span>
                    <span>¥${(item.price * item.quantity).toFixed(2)}</span>
                `;
                itemsList.appendChild(itemEl);
            });
            
            // 生成操作按钮
            const orderActions = document.getElementById('order-actions');
            orderActions.innerHTML = '';
            
            // 只有拥有编辑权限的用户才能看到状态更新按钮
            if (currentUser.permissions.includes('edit')) {
                // 根据当前状态生成可用的状态按钮
                const availableStatuses = getAvailableStatuses(order.status);
                
                availableStatuses.forEach(status => {
                    const btn = document.createElement('button');
                    btn.className = `px-3 py-1.5 rounded-md text-sm font-medium transition-all ${getStatusButtonClass(status)}`;
                    btn.textContent = getStatusText(status);
                    if (status === 'completed') {
                        btn.addEventListener('click', () => openPaymentMethodModal(order.id));
                    } else {
                        btn.addEventListener('click', () => updateOrderStatus(order.id, status));
                    }
                    orderActions.appendChild(btn);
                });
                
                // 添加分隔符
                if (availableStatuses.length > 0) {
                    const divider = document.createElement('span');
                    divider.className = 'mx-2 text-gray-400';
                    divider.textContent = '|';
                    orderActions.appendChild(divider);
                }
            }
            
            // 添加删除按钮（仅管理员权限）
            if (currentUser.permissions.includes('delete')) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white rounded-md text-sm font-medium transition-all';
                deleteBtn.textContent = '删除订单';
                deleteBtn.addEventListener('click', () => {
                    selectedOrderId = order.id;
                    orderDetailModal.classList.add('hidden');
                    deleteConfirmModal.classList.remove('hidden');
                });
                orderActions.appendChild(deleteBtn);
            }
            const payBtn = document.createElement('button');
            payBtn.className = 'px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm font-medium transition-all ml-2';
            payBtn.textContent = '付款';
            payBtn.addEventListener('click', () => markOrderPaid(order.id));
            orderActions.appendChild(payBtn);
            const receiptBtn = document.createElement('button');
            receiptBtn.className = 'px-3 py-1.5 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-md text-sm font-medium transition-all ml-2';
            receiptBtn.textContent = '收据';
            receiptBtn.addEventListener('click', () => openReceiptModal(order.id));
            orderActions.appendChild(receiptBtn);
            
            // 显示模态框
            orderDetailModal.classList.remove('hidden');
        }
        
        // 更新订单状态
        function updateOrderStatus(orderId, newStatus) {
            const order = orders.find(o => o.id === orderId);
            
            if (order) {
                order.status = newStatus;
                order.updatedAt = new Date().toISOString();
                if (newStatus === 'completed' && !order.settledAt) {
                    order.settledAt = new Date().toISOString();
                }
                
                // 保存数据
                saveData();
                
                // 重新渲染订单列表
                renderOrders();
                
                // 更新统计信息
                updateStatistics();
                
                // 关闭模态框
                orderDetailModal.classList.add('hidden');
                
                // 如果订单状态更新为已完成，显示成功消息并在3秒后自动转移到历史订单
                if (newStatus === 'completed') {
                    alert('订单已完成！将在3秒后自动转移到历史订单');
                    
                    // 3秒后自动转移到历史订单
                    setTimeout(() => {
                        order.status = 'history';
                        order.updatedAt = new Date().toISOString();
                        
                        // 保存数据
                        saveData();
                        
                        // 重新渲染订单列表
                        renderOrders();
                        
                        // 更新统计信息
                        updateStatistics();
                        
                        console.log(`订单 ${order.id} 已自动转移到历史订单`);
                    }, 3000);
                } else {
                    // 显示成功消息
                    alert('订单状态已更新');
                }
            }
        }
        
        // 处理删除订单
        function handleDeleteOrder() {
            if (!selectedOrderId) return;
            
            // 删除订单
            const deleted = orders.find(order => order.id === selectedOrderId);
            orders = orders.filter(order => order.id !== selectedOrderId);
            
            // 保存数据
            saveData();
            
            // 重新渲染订单列表
            renderOrders();
            
            // 更新订单管理列表（如果打开）
            if (!orderManagementModal.classList.contains('hidden')) {
                renderOrdersManagement(searchOrdersManagement.value.toLowerCase());
            }
            
            // 更新统计信息
            updateStatistics();
            
            // 关闭模态框
            deleteConfirmModal.classList.add('hidden');
            
            // 显示成功消息
            showUndoToast(deleted);
            logOperation('delete_order', `订单:${selectedOrderId}`);
        }
        let lastDeletedOrder = null;
        let undoTimer = null;
        function showUndoToast(order) {
            lastDeletedOrder = order;
            const toast = document.getElementById('undo-toast');
            toast.classList.remove('hidden');
            clearTimeout(undoTimer);
            undoTimer = setTimeout(() => {
                toast.classList.add('hidden');
                lastDeletedOrder = null;
            }, 3000);
        }
        
        // 更新统计信息
        function updateStatistics() {
            // 计算今日营业额
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayOrders = orders.filter(order => {
                const orderDate = new Date(order.createdAt);
                orderDate.setHours(0, 0, 0, 0);
                return orderDate.getTime() === today.getTime() && order.status !== 'cancelled';
            });
            
            const todayRevenue = todayOrders.reduce((sum, order) => sum + order.totalAmount, 0);
            
            // 计算总订单数和总收入
            const completedOrders = orders.filter(order => order.status !== 'cancelled');
            const totalRevenue = completedOrders.reduce((sum, order) => sum + order.totalAmount, 0);
            
            // 更新统计元素
            todayRevenueEl.textContent = `¥${todayRevenue.toFixed(2)}`;
            totalOrdersEl.textContent = completedOrders.length;
            totalRevenueEl.textContent = `¥${totalRevenue.toFixed(2)}`;
        }
        
        // 获取状态标签类
        function getStatusClass(status) {
            switch (status) {
                case 'pending': return 'status-pending';
                case 'completed': return 'status-completed';
                case 'cancelled': return 'status-cancelled';
                case 'soldOut': return 'status-soldOut';
                case 'history': return 'status-history';
                default: return '';
            }
        }
        
        // 获取状态文本
        function getStatusText(status) {
            switch (status) {
                case 'pending': return '待处理';
                case 'completed': return '已完成';
                case 'cancelled': return '已取消';
                case 'soldOut': return '已售罄';
                case 'history': return '历史订单';
                default: return '';
            }
        }
        function openPaymentMethodModal(orderId) {
            paymentOrderIdInput.value = orderId;
            paymentMethodModal.classList.remove('hidden');
        }
        function markOrderPaid(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            order.paid = true;
            order.updatedAt = new Date().toISOString();
            saveData();
            alert('订单已标记为已付款');
            renderOrders();
            updateStatistics();
            logOperation('mark_paid', `订单:${orderId}`);
        }
        function openReceiptModal(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            const createdAt = new Date(order.createdAt);
            const settledAt = order.settledAt ? new Date(order.settledAt) : new Date();
            receiptPurchaseTime.textContent = `${createdAt.getFullYear()}-${String(createdAt.getMonth() + 1).padStart(2, '0')}-${String(createdAt.getDate()).padStart(2, '0')} ${String(createdAt.getHours()).padStart(2, '0')}:${String(createdAt.getMinutes()).padStart(2, '0')}`;
            receiptSettleTime.textContent = `${settledAt.getFullYear()}-${String(settledAt.getMonth() + 1).padStart(2, '0')}-${String(settledAt.getDate()).padStart(2, '0')} ${String(settledAt.getHours()).padStart(2, '0')}:${String(settledAt.getMinutes()).padStart(2, '0')}`;
            const methodMap = { wechat: '微信支付', alipay: '支付宝', mpay: 'Mpay', cash: '现金' };
            receiptPaymentMethod.textContent = methodMap[order.paymentMethod] || '未指定';
            receiptCustomerName.textContent = order.customerName || '';
            receiptCustomerPhone.textContent = order.customerPhone || '';
            receiptCustomerAddress.textContent = order.customerAddress || '';
            receiptItems.innerHTML = '';
            (order.items || []).forEach(i => {
                const div = document.createElement('div');
                div.className = 'flex justify-between';
                div.innerHTML = `<span>${i.name} x${i.quantity}</span><span>单价¥${Number(i.price).toFixed(2)} 小计¥${(Number(i.price) * Number(i.quantity)).toFixed(2)}</span>`;
                receiptItems.appendChild(div);
            });
            receiptTotal.textContent = `¥${Number(order.totalAmount || 0).toFixed(2)}`;
            receiptModal.classList.remove('hidden');
        }
        
        // 获取状态按钮类
        function getStatusButtonClass(status) {
            switch (status) {
                case 'pending': return 'bg-yellow-500 hover:bg-yellow-600 text-white';
                case 'completed': return 'bg-green-500 hover:bg-green-600 text-white';
                case 'cancelled': return 'bg-red-500 hover:bg-red-600 text-white';
                case 'soldOut': return 'bg-gray-500 hover:bg-gray-600 text-white';
                case 'history': return 'bg-blue-500 hover:bg-blue-600 text-white';
                default: return '';
            }
        }
        
        // 根据当前状态获取可用的状态转换
        function getAvailableStatuses(currentStatus) {
            const statusMap = {
                'pending': ['completed', 'cancelled', 'soldOut'],
                'completed': [],
                'cancelled': [],
                'soldOut': [],
                'history': []
            };
            
            return statusMap[currentStatus] || [];
        }
        
        // 显示订单管理
        function showOrderManagement() {
            renderOrdersManagement('');
            orderManagementModal.classList.remove('hidden');
        }
        
        // 显示客户管理
        function showCustomerManagement() {
            renderCustomers('');
            customerManagementModal.classList.remove('hidden');
        }
        
        // 渲染订单管理列表
        function renderOrdersManagement(searchTerm) {
            let filteredOrders = orders;
            
            // 应用搜索
            if (searchTerm) {
                filteredOrders = filteredOrders.filter(order => 
                    order.id.toLowerCase().includes(searchTerm) ||
                    order.customerName.toLowerCase().includes(searchTerm) ||
                    order.customerPhone.includes(searchTerm)
                );
            }
            
            // 不显示历史订单
            filteredOrders = filteredOrders.filter(order => order.status !== 'history');
            
            // 显示或隐藏空订单提示
            if (filteredOrders.length === 0) {
                ordersManagementList.innerHTML = '';
                emptyOrdersManagement.classList.remove('hidden');
            } else {
                emptyOrdersManagement.classList.add('hidden');
                
                // 渲染订单列表
                ordersManagementList.innerHTML = '';
                ordersManagementList.innerHTML = '';
                
                filteredOrders.forEach(order => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 cursor-pointer';
                    
                    // 格式化日期
                    const createdAt = new Date(order.createdAt);
                    const formattedDate = `${createdAt.getFullYear()}-${String(createdAt.getMonth() + 1).padStart(2, '0')}-${String(createdAt.getDate()).padStart(2, '0')} ${String(createdAt.getHours()).padStart(2, '0')}:${String(createdAt.getMinutes()).padStart(2, '0')}`;
                    
                    // 获取状态标签类
                    const statusClass = getStatusClass(order.status);
                    
                    // 获取状态标签文本
                    const statusText = getStatusText(order.status);
                    
                    // 商品列表
                    const itemsText = order.items.map(item => `${item.name} x ${item.quantity}`).join(', ');
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${order.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${order.customerName}</div>
                                    <div class="text-sm text-gray-500">${order.customerPhone}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${itemsText}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">¥${order.totalAmount.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formattedDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-primary hover:text-blue-800 mr-3 edit-order-btn" data-id="${order.id}">
                                编辑
                            </button>
                        </td>
                    `;
                    
                    ordersManagementList.appendChild(row);
                });
                
                // 添加编辑订单事件
                document.querySelectorAll('.edit-order-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const orderId = e.currentTarget.dataset.id;
                        openEditOrderModal(orderId);
                    });
                });
            }
        }
        
        // 渲染客户列表
        function renderCustomers(searchTerm) {
            const customersMap = new Map();
            extraCustomers.forEach(c => {
                customersMap.set(c.phone, {
                    name: c.name || '',
                    phone: c.phone || '',
                    address: c.address || '',
                    notes: c.notes || '',
                    orderCount: 0,
                    totalSpent: 0
                });
            });
            orders.forEach(order => {
                const key = order.customerPhone;
                if (!key) return;
                if (!customersMap.has(key)) {
                    customersMap.set(key, {
                        name: order.customerName || '',
                        phone: order.customerPhone || '',
                        address: order.customerAddress || '',
                        notes: order.notes || '',
                        orderCount: 0,
                        totalSpent: 0
                    });
                }
                const c = customersMap.get(key);
                c.name = order.customerName || c.name;
                if (order.customerAddress) c.address = order.customerAddress;
                if (order.notes) c.notes = order.notes;
                c.orderCount += 1;
                c.totalSpent += (order.totalAmount || 0);
            });
            
            const customers = Array.from(customersMap.values());
            
            // 应用搜索
            let filteredCustomers = customers;
            if (searchTerm) {
                filteredCustomers = filteredCustomers.filter(customer => 
                    customer.name.toLowerCase().includes(searchTerm) ||
                    customer.phone.includes(searchTerm) ||
                    customer.address.toLowerCase().includes(searchTerm)
                );
            }
            
            // 显示或隐藏空客户提示
            if (filteredCustomers.length === 0) {
                customersList.innerHTML = '';
                emptyCustomers.classList.remove('hidden');
            } else {
                emptyCustomers.classList.add('hidden');
                
                // 渲染客户列表
                customersList.innerHTML = '';
                customersList.innerHTML = '';
                
                filteredCustomers.forEach(customer => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 cursor-pointer';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${customer.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${customer.phone}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${customer.address}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.orderCount}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">¥${customer.totalSpent.toFixed(2)}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${customer.notes}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-primary hover:text-blue-800 mr-3 edit-customer-btn" data-phone="${customer.phone}">
                                编辑
                            </button>
                        </td>
                    `;
                    
                    customersList.appendChild(row);
                });
                
                // 添加编辑客户事件
                document.querySelectorAll('.edit-customer-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const phone = e.currentTarget.dataset.phone;
                        openEditCustomerModal(phone);
                    });
                });
            }
        }

        function handleQuickAddCustomer() {
            const name = (quickCustomerName && quickCustomerName.value || '').trim();
            const phone = (quickCustomerPhone && quickCustomerPhone.value || '').trim();
            const address = (quickCustomerAddress && quickCustomerAddress.value || '').trim();
            const notes = (quickCustomerNotes && quickCustomerNotes.value || '').trim();
            const type = (quickCustomerType && quickCustomerType.value) || '新客戶';
            if (!name || !phone) { alert('请输入客户姓名和联系电话'); return; }
            const existsInOrders = orders.some(o => o.customerPhone === phone);
            const existsInExtras = extraCustomers.some(c => c.phone === phone);
            if (existsInOrders || existsInExtras) { alert('该联系电话已存在'); return; }
            extraCustomers.push({ name, phone, address, notes, type });
            saveData();
            if (quickCustomerName) quickCustomerName.value = '';
            if (quickCustomerPhone) quickCustomerPhone.value = '';
            if (quickCustomerAddress) quickCustomerAddress.value = '';
            if (quickCustomerNotes) quickCustomerNotes.value = '';
            if (quickCustomerType) quickCustomerType.value = '新客戶';
            const term = (searchCustomers && searchCustomers.value || '').toLowerCase();
            renderCustomers(term);
            alert('客户添加成功');
            logOperation('add_customer', `客户:${name} 电话:${phone}`);
        }

        function buildCustomerDataset() {
            const map = new Map();
            extraCustomers.forEach(c => {
                const key = c.phone || `${c.name}-${c.address}`;
                if (!map.has(key)) map.set(key, { name: c.name || '', phone: c.phone || '', address: c.address || '', notes: c.notes || '' });
            });
            orders.forEach(o => {
                const key = o.customerPhone || `${o.customerName}-${o.customerAddress}`;
                if (!map.has(key)) map.set(key, { name: o.customerName || '', phone: o.customerPhone || '', address: o.customerAddress || '', notes: o.notes || '' });
            });
            return Array.from(map.values());
        }
        function getQuickTerm() {
            const a = (quickCustomerName && quickCustomerName.value || '').trim();
            const b = (quickCustomerPhone && quickCustomerPhone.value || '').trim();
            const c = (quickCustomerAddress && quickCustomerAddress.value || '').trim();
            const d = (quickCustomerNotes && quickCustomerNotes.value || '').trim();
            return a || b || c || d;
        }
        function findSimilarCustomers(term) {
            const t = String(term || '').toLowerCase();
            if (!t) return [];
            const data = buildCustomerDataset();
            const res = data.filter(x => (x.name||'').toLowerCase().includes(t) || (x.phone||'').toLowerCase().includes(t) || (x.address||'').toLowerCase().includes(t) || (x.notes||'').toLowerCase().includes(t));
            return res.slice(0, 5);
        }
        function renderQuickCustomerSuggestions(term) {
            if (!quickCustomerSuggestions) return;
            const list = findSimilarCustomers(term);
            if (list.length === 0) { quickCustomerSuggestions.innerHTML = ''; return; }
            quickCustomerSuggestions.innerHTML = list.map((x, i) => `
                <div class="flex items-center justify-between bg-white border border-gray-200 rounded-md px-3 py-2">
                    <div class="text-sm text-gray-700">
                        <div>${x.name || ''} ${x.phone ? '（'+x.phone+'）' : ''}</div>
                        <div class="text-gray-500">${x.address || ''}</div>
                        <div class="text-gray-500">${x.notes || ''}</div>
                    </div>
                    <button class="px-3 py-1 bg-primary text-white rounded-md quick-apply-suggestion" data-index="${i}">填入</button>
                </div>
            `).join('');
            quickCustomerSuggestions.querySelectorAll('.quick-apply-suggestion').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.currentTarget.getAttribute('data-index'), 10);
                    const chosen = list[idx];
                    if (!chosen) return;
                    if (quickCustomerName) quickCustomerName.value = chosen.name || '';
                    if (quickCustomerPhone) quickCustomerPhone.value = chosen.phone || '';
                    if (quickCustomerAddress) quickCustomerAddress.value = chosen.address || '';
                    if (quickCustomerNotes) quickCustomerNotes.value = chosen.notes || '';
                });
            });
        }
        
        // 打开编辑订单模态框
        function openEditOrderModal(orderId) {
            const order = orders.find(o => o.id === orderId);
            
            if (order) {
                document.getElementById('edit-order-id').value = order.id;
                document.getElementById('edit-customer-name').value = order.customerName;
                document.getElementById('edit-customer-phone').value = order.customerPhone;
                document.getElementById('edit-customer-address').value = order.customerAddress || '';
                document.getElementById('edit-order-status').value = order.status;
                document.getElementById('edit-order-notes').value = order.notes || '';
                
                // 清空商品列表
                const editItemsContainer = document.getElementById('edit-items-container');
                editItemsContainer.innerHTML = '';
                
                // 添加商品行
                order.items.forEach(item => {
                    const itemRow = document.createElement('div');
                    itemRow.className = 'item-row grid grid-cols-10 gap-2';
                    
                    // 动态生成商品选项
                    let options = '<option value="">选择商品</option>';
                    products.forEach(product => {
                        options += `<option value="${product.name}" ${product.name === item.name ? 'selected' : ''}>${product.name} - ¥${product.price}</option>`;
                    });
                    
                    itemRow.innerHTML = `
                        <select class="item-select col-span-5 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            ${options}
                        </select>
                        <input type="number" class="item-quantity col-span-2 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" min="1" value="${item.quantity}">
                        <span class="item-price col-span-2 px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-700" readonly>¥${item.price}</span>
                        <button type="button" class="remove-item col-span-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition-all">
                            <i class="fa fa-trash"></i>
                        </button>
                    `;
                    
                    editItemsContainer.appendChild(itemRow);
                    
                    // 添加事件监听器
                    const select = itemRow.querySelector('.item-select');
                    const quantity = itemRow.querySelector('.item-quantity');
                    const removeBtn = itemRow.querySelector('.remove-item');
                    
                    select.addEventListener('change', updateEditOrderTotal);
                    quantity.addEventListener('input', updateEditOrderTotal);
                    
                    removeBtn.addEventListener('click', () => {
                        // 确保至少有一行
                        if (editItemsContainer.children.length > 1) {
                            itemRow.remove();
                            updateEditOrderTotal();
                        } else {
                            alert('至少需要一项商品');
                        }
                    });
                });
                
                // 添加"添加商品"按钮
                const addItemRow = document.createElement('div');
                addItemRow.className = 'mt-3 text-center';
                addItemRow.innerHTML = `
                    <button type="button" id="add-edit-item" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-md transition-all">
                        <i class="fa fa-plus mr-1"></i> 添加商品
                    </button>
                `;
                
                editItemsContainer.appendChild(addItemRow);
                
                // 添加添加商品事件
                document.getElementById('add-edit-item').addEventListener('click', () => {
                    addNewEditItemRow();
                });
                
                // 更新总价
                updateEditOrderTotal();
                
                // 显示模态框
                document.getElementById('edit-order-modal').classList.remove('hidden');
            }
        }
        
        // 添加新的编辑商品行
        function addNewEditItemRow() {
            const editItemsContainer = document.getElementById('edit-items-container');
            const addButtonRow = document.getElementById('add-edit-item').parentElement;
            
            const itemRow = document.createElement('div');
            itemRow.className = 'item-row grid grid-cols-10 gap-2';
            
            // 动态生成商品选项
            let options = '<option value="">选择商品</option>';
            products.forEach(product => {
                options += `<option value="${product.name}">${product.name} - ¥${product.price}</option>`;
            });
            
            itemRow.innerHTML = `
                <select class="item-select col-span-5 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    ${options}
                </select>
                <input type="number" class="item-quantity col-span-2 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" min="1" value="1">
                <span class="item-price col-span-2 px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-700" readonly>¥0</span>
                <button type="button" class="remove-item col-span-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition-all">
                    <i class="fa fa-trash"></i>
                </button>
            `;
            
            // 插入到添加按钮之前
            editItemsContainer.insertBefore(itemRow, addButtonRow);
            
            // 添加事件监听器
            const select = itemRow.querySelector('.item-select');
            const quantity = itemRow.querySelector('.item-quantity');
            const removeBtn = itemRow.querySelector('.remove-item');
            
            select.addEventListener('change', updateEditOrderTotal);
            quantity.addEventListener('input', updateEditOrderTotal);
            
            removeBtn.addEventListener('click', () => {
                // 确保至少有一行
                if (editItemsContainer.children.length > 2) { // 包括添加按钮行
                    itemRow.remove();
                    updateEditOrderTotal();
                } else {
                    alert('至少需要一项商品');
                }
            });
        }
        
        // 更新编辑订单总价
        function updateEditOrderTotal() {
            let total = 0;
            
            document.querySelectorAll('#edit-items-container .item-row').forEach(row => {
                const select = row.querySelector('.item-select');
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                
                if (select.value) {
                    const product = products.find(p => p.name === select.value);
                    if (product) {
                        const itemTotal = product.price * quantity;
                        row.querySelector('.item-price').textContent = `¥${product.price}`;
                        total += itemTotal;
                    }
                }
            });
            
            document.getElementById('edit-order-total').textContent = `¥${total.toFixed(2)}`;
        }
        
        // 处理编辑订单
        function handleEditOrder(e) {
            e.preventDefault();
            
            const orderId = document.getElementById('edit-order-id').value;
            const customerName = document.getElementById('edit-customer-name').value;
            const customerPhone = document.getElementById('edit-customer-phone').value;
            const customerAddress = document.getElementById('edit-customer-address').value;
            const status = document.getElementById('edit-order-status').value;
            const notes = document.getElementById('edit-order-notes').value;
            
            // 收集商品信息
            const items = [];
            let totalAmount = 0;
            let isValid = true;
            
            document.querySelectorAll('#edit-items-container .item-row').forEach(row => {
                const select = row.querySelector('.item-select');
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                
                if (!select.value) {
                    isValid = false;
                    return;
                }
                
                const product = products.find(p => p.name === select.value);
                if (product && quantity > 0) {
                    items.push({
                        name: product.name,
                        quantity: quantity,
                        price: product.price
                    });
                    
                    totalAmount += product.price * quantity;
                } else {
                    isValid = false;
                }
            });
            
            if (!isValid || items.length === 0) {
                alert('请填写完整的订单信息');
                return;
            }
            
            // 更新订单
            const orderIndex = orders.findIndex(o => o.id === orderId);
            if (orderIndex !== -1) {
                orders[orderIndex] = {
                    ...orders[orderIndex],
                    customerName: customerName,
                    customerPhone: customerPhone,
                    customerAddress: customerAddress,
                    items: items,
                    status: status,
                    notes: notes,
                    totalAmount: totalAmount,
                    updatedAt: new Date().toISOString()
                };
                
                // 保存数据
                saveData();
                
                // 重新渲染订单列表
                renderOrders();
                
                // 更新订单管理列表（如果打开）
                if (!document.getElementById('order-management-modal').classList.contains('hidden')) {
                    renderOrdersManagement(document.getElementById('search-orders-management').value.toLowerCase());
                }
                
                // 更新统计信息
                updateStatistics();
                
                // 关闭模态框
                document.getElementById('edit-order-modal').classList.add('hidden');
                
                // 显示成功消息
                alert('订单已更新');
            }
        }
        
        // 打开编辑客户模态框
        function openEditCustomerModal(phone) {
            const customerOrders = orders.filter(order => order.customerPhone === phone);
            if (customerOrders.length > 0) {
                const firstOrder = customerOrders[0];
                document.getElementById('edit-customer-phone-hidden').value = phone;
                document.getElementById('edit-customer-name-detail').value = firstOrder.customerName;
                document.getElementById('edit-customer-phone-detail').value = firstOrder.customerPhone;
                document.getElementById('edit-customer-address').value = firstOrder.customerAddress || '';
                document.getElementById('edit-customer-notes').value = firstOrder.notes || '';
                document.getElementById('edit-customer-modal').classList.remove('hidden');
                return;
            }
            const ec = extraCustomers.find(c => c.phone === phone);
            if (!ec) return;
            document.getElementById('edit-customer-phone-hidden').value = phone;
            document.getElementById('edit-customer-name-detail').value = ec.name || '';
            document.getElementById('edit-customer-phone-detail').value = ec.phone || '';
            document.getElementById('edit-customer-address').value = ec.address || '';
            document.getElementById('edit-customer-notes').value = ec.notes || '';
            document.getElementById('edit-customer-modal').classList.remove('hidden');
        }
        
        // 处理编辑客户
        function handleEditCustomer(e) {
            e.preventDefault();
            
            const oldPhone = document.getElementById('edit-customer-phone-hidden').value;
            const newName = document.getElementById('edit-customer-name-detail').value;
            const newPhone = document.getElementById('edit-customer-phone-detail').value;
            const address = document.getElementById('edit-customer-address').value;
            const notes = document.getElementById('edit-customer-notes').value;
            if (newPhone !== oldPhone) {
                const conflictInOrders = orders.some(o => o.customerPhone === newPhone);
                const conflictInExtras = extraCustomers.some(c => c.phone === newPhone);
                if (conflictInOrders || conflictInExtras) { alert('该联系电话已存在'); return; }
            }
            
            // 更新所有相关订单
            orders = orders.map(order => {
                if (order.customerPhone === oldPhone) {
                    return {
                        ...order,
                        customerName: newName,
                        customerPhone: newPhone,
                        customerAddress: address,
                        notes: notes
                    };
                }
                return order;
            });
            
            extraCustomers = extraCustomers.map(c => {
                if (c.phone === oldPhone) {
                    return { ...c, name: newName, phone: newPhone, address, notes };
                }
                return c;
            });
            // 保存数据
            saveData();
            
            // 重新渲染订单列表
            renderOrders();
            
            // 更新客户管理列表（如果打开）
            if (!document.getElementById('customer-management-modal').classList.contains('hidden')) {
                renderCustomers(document.getElementById('search-customers').value.toLowerCase());
            }
            
            // 关闭模态框
            document.getElementById('edit-customer-modal').classList.add('hidden');
            
            alert('客户信息已更新');
            logOperation('update_customer', `电话:${oldPhone}→${newPhone}`);
        }
    </script>
</body>
</html>
